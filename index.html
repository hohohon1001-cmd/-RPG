<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ìœ ê¸°ì‚¬ RPG â€“ ë¦¬ë©”ì´í¬ (ì§€ë„/ìƒì /ìŠ¤í‚¬)</title>
<!-- ê°„ì§€ë‚˜ëŠ” UI ìŠ¤íƒ€ì¼ + ë°°ê²½(ë¬´ë£Œ ì´ë¯¸ì§€) -->
<style>
:root{
  --bg-color-1:#071027;
  --bg-color-2:#0f1530;
  --accent:#7c8cff;
  --accent-2:#ff9b9b;
  --glass: rgba(255,255,255,0.04);
  --card: rgba(255,255,255,0.03);
  --glass-2: rgba(255,255,255,0.02);
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Inter, "Segoe UI", Roboto, system-ui, -apple-system; background:linear-gradient(180deg,var(--bg-color-1),#020212);color:#e6e8ff}
body{
  background-image: url('https://images.unsplash.com/photo-1501785888041-af3ef285b470?auto=format&fit=crop&w=1800&q=60');
  background-size:cover;
  background-position:center;
  display:flex;align-items:center;justify-content:center;padding:28px;
}

/* ì»¨í…Œì´ë„ˆ */
.app{
  width:100%; max-width:1100px; border-radius:20px; overflow:hidden;
  background: linear-gradient(180deg, rgba(2,6,23,0.6), rgba(1,3,10,0.8));
  box-shadow: 0 10px 50px rgba(0,0,0,0.7);
  display:grid; grid-template-columns: 420px 1fr; gap:18px; padding:18px;
  backdrop-filter: blur(6px);
}

/* ì¢Œì¸¡ ì»¬ëŸ¼ â€“ í”Œë ˆì´/ì •ë³´ */
.left{
  display:flex; flex-direction:column; gap:12px;
}

/* HUD ì¹´ë“œ */
.hud{
  background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));
  border-radius:14px; padding:12px; box-shadow: 0 6px 18px rgba(0,0,0,0.6);
}
.hud-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
.hud-item{background:var(--card);padding:8px;border-radius:10px;text-align:center;font-size:13px}
.hud-item .label{font-size:11px;color:#b9c0ff}
.hud-item .value{font-weight:700;font-size:18px;margin-top:6px;color:var(--accent)}

/* MP bar + HP bar inside monster card */
.center-card{
  background: linear-gradient(180deg, rgba(10,14,30,0.5), rgba(5,7,12,0.5));
  border-radius:14px;padding:14px; box-shadow: 0 8px 20px rgba(0,0,0,0.6);
}

/* ë§µ ì¹´ë“œ */
.map{
  background: linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
  border-radius:12px;padding:10px; display:flex;flex-direction:column;gap:8px;
}
.map-grid{display:flex;gap:8px;flex-wrap:wrap}
.map-node{
  flex: 1 1 30%; min-width:110px; padding:10px; border-radius:10px;
  background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
  text-align:center; cursor:pointer; transition:transform .12s;
  border:1px solid rgba(255,255,255,0.03);
}
.map-node.locked{opacity:0.45; filter:grayscale(40%); cursor:not-allowed}
.map-node:hover{transform:translateY(-6px)}

/* ëª¬ìŠ¤í„° ì¹´ë“œ */
.monster-card{border-radius:14px;padding:12px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); box-shadow:0 10px 30px rgba(0,0,0,0.6); text-align:center}
.monster-name{font-size:20px;font-weight:700;margin-bottom:8px}
.hp-bar{height:12px;background:#111;border-radius:8px;overflow:hidden}
.hp-fill{height:100%;background:linear-gradient(90deg,#ff3b3b,#ff9b9b);width:100%;transition:width .08s linear}

/* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
.btn{
  display:inline-block;padding:10px 12px;border-radius:12px;border:none;cursor:pointer;color:white;font-weight:700;
  background:linear-gradient(90deg,var(--accent),#5b62e8); box-shadow:0 6px 18px rgba(92,97,214,0.16);
}
.btn.secondary{background:linear-gradient(90deg,#2e7bff,#00d4a5); box-shadow:0 6px 18px rgba(0,212,165,0.12)}
.btn.warn{background:linear-gradient(90deg,#ff7b7b,#ffb86b); color:#110f0f}
.row{display:flex;gap:8px;align-items:center}
.col{display:flex;flex-direction:column;gap:8px}

/* ì˜¤ë¥¸ìª½ â€“ ìƒì /ë¡œê·¸/ìŠ¤í‚¬/ì¸ë²¤í† ë¦¬ */
.right{
  display:flex;flex-direction:column;gap:12px;
}

/* ìƒì /ë¡œê·¸ ì¹´ë“œ */
.card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); padding:12px;border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,0.6)}
.shop-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
.shop-item{padding:10px;border-radius:10px;background:linear-gradient(90deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02));text-align:center}
.small{font-size:12px;color:#bfc7ff}
.badge{background:rgba(0,0,0,0.25);padding:6px 8px;border-radius:10px;font-weight:700;color:#fff}

/* ìŠ¤í‚¬ ë²„íŠ¼ */
.skill-row{display:flex;gap:8px}
.skill-btn{flex:1;padding:10px;border-radius:10px;background:linear-gradient(90deg,#ff8b8b,#ffc26f);color:#110; font-weight:800;cursor:pointer;position:relative;overflow:hidden}
.cooldown{position:absolute;left:0;top:0;height:100%;background:rgba(0,0,0,0.45);width:0%;transition:width .2s linear;color:#fff;display:flex;align-items:center;justify-content:center;font-weight:800}

/* ë¡œê·¸ */
.log{height:90px; overflow:auto; font-size:13px; color:#cfd6ff; padding:8px; border-radius:8px; background:linear-gradient(90deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02));}

/* responsive */
@media(max-width:980px){
  .app{grid-template-columns:1fr; padding:12px}
}
</style>
</head>
<body>
<div class="app" id="app">
  <!-- LEFT -->
  <div class="left">
    <div class="hud">
      <div class="hud-grid">
        <div class="hud-item">
          <div class="label">LV</div>
          <div class="value" id="playerLv">1</div>
        </div>
        <div class="hud-item">
          <div class="label">ì§ì—…</div>
          <div class="value" id="jobText">ë©œë¡œìš°ê¸‰</div>
        </div>
        <div class="hud-item">
          <div class="label">ATK</div>
          <div class="value" id="atk">1</div>
        </div>

        <div class="hud-item">
          <div class="label">ê°•í™”</div>
          <div class="value" id="upgradeLv">1</div>
        </div>
        <div class="hud-item">
          <div class="label">ğŸ’°</div>
          <div class="value" id="coin">0</div>
        </div>
        <div class="hud-item">
          <div class="label">EXP</div>
          <div class="value" id="expText">0/10</div>
        </div>
      </div>
    </div>

    <!-- MAP -->
    <div class="map card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong>ì§€ë„</strong>
        <span class="small">í´ë¦­í•˜ë©´ í•´ë‹¹ ì§€ì—­ìœ¼ë¡œ ì´ë™(ë ˆë²¨ì¡°ê±´ ì¶©ì¡± ì‹œ)</span>
      </div>
      <div class="map-grid" id="mapGrid" style="margin-top:8px">
        <!-- nodes generated by JS -->
      </div>
    </div>

    <!-- ëª¬ìŠ¤í„° (ì¤‘ì•™ í° ì¹´ë“œ) -->
    <div class="center-card monster-card">
      <div class="monster-name" id="monsterName">ë©œë‹˜</div>
      <div class="hp-bar" style="margin-bottom:8px"><div id="hpFill" class="hp-fill"></div></div>

      <div class="row" style="justify-content:space-between; margin-top:8px">
        <button class="btn" onclick="attack()">ê³µê²©</button>
        <button class="btn secondary" id="autoBtn" onclick="toggleAuto()">ğŸ¤– ìë™ì‚¬ëƒ¥ OFF</button>
        <button class="btn warn" id="upgradeBtn" onclick="upgrade()">ğŸ”§ ê°•í™” (<span id="upgradeCost">20</span>)</button>
      </div>

      <div style="margin-top:10px" class="row">
        <div style="flex:1">
          <div class="small">MP</div>
          <div style="height:10px;background:#111;border-radius:8px;overflow:hidden"><div id="mpFill" style="height:100%;width:100%;background:linear-gradient(90deg,#6befff,#4db6ff);"></div></div>
        </div>
        <div style="width:110px;text-align:right">
          <div class="small">Level</div>
          <div style="font-weight:800" id="playerLvSmall">1</div>
        </div>
      </div>
    </div>
  </div>

  <!-- RIGHT -->
  <div class="right">
    <!-- SHOP -->
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong>ìƒì </strong>
        <span class="small">ê³¨ë“œë¡œ ì•„ì´í…œì„ êµ¬ë§¤í•˜ì„¸ìš”</span>
      </div>
      <div class="shop-grid" id="shopGrid" style="margin-top:10px">
        <!-- shop items rendered by JS -->
      </div>
    </div>

    <!-- SKILLS -->
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong>ìŠ¤í‚¬</strong>
        <span class="small">MPì™€ ì¿¨ë‹¤ìš´ì„ í™•ì¸</span>
      </div>
      <div class="skill-row" style="margin-top:10px">
        <div class="skill-btn" id="skill1Btn" onclick="useSkill(1)">
          POWER STRIKE<br><small class="small">MP 20 Â· ì¿¨ë‹¤ìš´ 5s</small>
          <div class="cooldown" id="skill1Cd"></div>
        </div>
        <div class="skill-btn" id="skill2Btn" onclick="useSkill(2)" style="background:linear-gradient(90deg,#ffd18a,#ff8b8b)">
          WHIRLWIND<br><small class="small">MP 40 Â· ì¿¨ë‹¤ìš´ 12s</small>
          <div class="cooldown" id="skill2Cd"></div>
        </div>
      </div>
      <div style="margin-top:10px" class="row">
        <button class="btn" onclick="jobChange()" id="jobBtn" style="display:none">ğŸ”® ì „ì§</button>
        <button class="btn secondary" onclick="checkAttendance()">ğŸ“… ì¶œì„ì²´í¬</button>
      </div>
    </div>

    <!-- LOG -->
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong>ë¡œê·¸</strong>
        <div class="badge" id="timeBadge">ì €ì¥ë¨</div>
      </div>
      <div class="log" id="log" style="margin-top:8px">ê²Œì„ ì‹œì‘ â€” í™”ë©´ì„ í´ë¦­í•´ ì‚¬ìš´ë“œ í™œì„±í™”</div>
    </div>
  </div>
</div>

<!-- audio -->
<audio id="hitSound" src="https://assets.mixkit.co/sfx/preview/mixkit-quick-hit-2187.mp3"></audio>
<audio id="killSound" src="https://assets.mixkit.co/sfx/preview/mixkit-video-game-win-2016.mp3"></audio>
<audio id="upgradeSound" src="https://assets.mixkit.co/sfx/preview/mixkit-achievement-bell-600.mp3"></audio>
<audio id="failSound" src="https://assets.mixkit.co/sfx/preview/mixkit-wrong-answer-fail-notification-946.mp3"></audio>
<audio id="levelSound" src="https://assets.mixkit.co/sfx/preview/mixkit-magic-game-win-1949.mp3"></audio>
<audio id="bossSound" src="https://assets.mixkit.co/sfx/preview/mixkit-dramatic-hit-166.mp3"></audio>

<script>
/* =========================
   ê²Œì„ ìƒíƒœ (ì´ˆê¸°ê°’)
   ========================= */
let coins = 0;
let atk = 1;
let playerLv = 1;
let exp = 0;
let nextExp = 5; // ë‚®ì•„ì§„ ì‹œì‘ê°’
let upgradeLv = 1;
let upgradeChance = 90;
let job = "ë©œë¡œìš°ê¸‰";
let jobStage = 0;
let goldBonus = 1;
let kills = 0;

let monsterHp = 10, monsterMaxHp = 10;

let mp = 100, maxMp = 100;   // ë§ˆë‚˜
let mpRegen = 1;            // ì´ˆë‹¹ íšŒë³µ

let autoHunt = false, autoInterval = null;
let soundEnabled = false;

// ìŠ¤í‚¬ ìƒíƒœ
let skillState = {
  1: { cd:5, last: -9999, mp:20, name:"POWER STRIKE" },
  2: { cd:12, last: -9999, mp:40, name:"WHIRLWIND" }
};

// XP boost ìƒíƒœ (ìƒì ì—ì„œ êµ¬ë§¤)
let xpBoost = { active:false, endAt:0, multiplier:1 };

/* ì§€ì—­/ëª¬ìŠ¤í„° (ì›ë³¸ ì´ë¦„ ìœ ì§€) */
const areas = [
  {name:"ğŸŒ± ì¼ëª»íƒ€", lv:1},
  {name:"ğŸŒ´ ê¸‰ëª»íƒ€", lv:10},
  {name:"â„ ìœ ê¸°ì‚¬ì˜ ì°¨ê°€ìš´ ë†ë‹´", lv:20},
  {name:"ğŸœ ì‹íƒ", lv:30},
  {name:"ğŸŒ‹ íŒ€ë‚˜ë¹ ", lv:40},
  {name:"ğŸŒŒ ìœ ê¸°ì‚¬ ë””ìŠ¤ì½”ë“œ", lv:50}
];
const monsters = [
  ["ì–´ë ¤ì›Œ í•˜ì‹œëŠ” ë©œë‹˜","ë²¨í‚¤ë‹˜"],
  ["ë˜ ëª»ê¹¨ê³  ìˆëŠ” ë©œë‹˜","ë¨¼ì €ê¹¬ ìš°ì°¸ë‹˜"],
  ["ì™•ì´ ë„˜ì–´ì§€ë©´? í‚¹ì½© ã…‹ã…‹ã…‹","ì•„ë‹ˆ ì‹¤ìˆ˜ë¡œ ë¼ì´ë²Œ ë“¤ì–´ê°"],
  ["ì˜·ì— ë–¨ì–´ì§„ ë°¥í’€","í›„ì‹ìœ¼ë¡  ì¤€ë¸Œë ˆë“œ ì—‰ë©ì´"],
  ["ì§­ ìœ ê¸°ì‚¬","ë©œë‹˜ìœ¼ë¡œ ìœ„ì¥í•œ ì¤€ë¸Œë ˆë“œ"],
  ["ìì¹¼ë‹˜","í‘í™”í•œ ë©œë‹˜","ë³´ìŠ¤: ìœ ê¸°ì‚¬ok"]
];

/* UI ìš”ì†Œ ìºì‹œ */
const playerLvSpan = document.getElementById("playerLv");
const playerLvSmall = document.getElementById("playerLvSmall");
const atkSpan = document.getElementById("atk");
const coinSpan = document.getElementById("coin");
const expTextSpan = document.getElementById("expText");
const upgradeLvSpan = document.getElementById("upgradeLv");
const upgradeCostSpan = document.getElementById("upgradeCost");
const jobTextSpan = document.getElementById("jobText");
const hpFill = document.getElementById("hpFill");
const mpFill = document.getElementById("mpFill");
const monsterNameElem = document.getElementById("monsterName");
const areaTextElem = document.getElementById("areaText");
const mapGrid = document.getElementById("mapGrid");
const shopGrid = document.getElementById("shopGrid");
const logElem = document.getElementById("log");
const timeBadge = document.getElementById("timeBadge");

const hitSound = document.getElementById("hitSound");
const killSound = document.getElementById("killSound");
const upgradeSound = document.getElementById("upgradeSound");
const failSound = document.getElementById("failSound");
const levelSound = document.getElementById("levelSound");
const bossSound = document.getElementById("bossSound");

/* =========================
   ì‚¬ìš´ë“œ ì´ˆê¸°í™” (ë¸Œë¼ìš°ì € ì •ì±…)
   ========================= */
function enableSoundOnce(){
  [hitSound, killSound, upgradeSound, failSound, levelSound, bossSound].forEach(s=>{
    s.volume = 0.9;
    s.play().catch(()=>{});
    s.pause();
    s.currentTime = 0;
  });
  soundEnabled = true;
  log("ğŸ”Š ì‚¬ìš´ë“œ í™œì„±í™” ì™„ë£Œ!");
}
// í•œë²ˆë§Œ ë°”ì¸ë”©
document.body.addEventListener("click", enableSoundOnce, { once:true });

/* =========================
   ì €ì¥ / ë¶ˆëŸ¬ì˜¤ê¸° (ì•ˆì „ í• ë‹¹)
   ========================= */
function save(){
  try{
    const data = {
      coins, atk, playerLv, exp, nextExp, upgradeLv, upgradeChance, job, jobStage, goldBonus, kills,
      monsterHp, monsterMaxHp, mp, maxMp, mpRegen, skillState, xpBoost
    };
    localStorage.setItem("yugisaRPG2", JSON.stringify(data));
    localStorage.setItem("yugisaRPG2_time", String(Date.now()));
    timeBadge.textContent = "ì €ì¥ë¨";
  }catch(e){
    console.error("Save failed:", e);
  }
}

function load(){
  const raw = localStorage.getItem("yugisaRPG2");
  if(!raw) return;
  try{
    const s = JSON.parse(raw);
    coins = Number(s.coins)||0;
    atk = Number(s.atk)||1;
    playerLv = Number(s.playerLv)||1;
    exp = Number(s.exp)||0;
    nextExp = Number(s.nextExp)||5;
    upgradeLv = Number(s.upgradeLv)||1;
    upgradeChance = Number(s.upgradeChance)||90;
    job = s.job||"ë©œë¡œìš°ê¸‰";
    jobStage = Number(s.jobStage)||0;
    goldBonus = Number(s.goldBonus)||1;
    kills = Number(s.kills)||0;
    monsterHp = Number(s.monsterHp)||monsterHp;
    monsterMaxHp = Number(s.monsterMaxHp)||monsterMaxHp;
    mp = Number(s.mp) || maxMp;
    maxMp = Number(s.maxMp) || maxMp;
    mpRegen = Number(s.mpRegen) || mpRegen;
    if(s.skillState) {
      // restore last times but ensure numbers
      Object.keys(s.skillState).forEach(k=>{
        skillState[k] = s.skillState[k];
      });
    }
    if(s.xpBoost) xpBoost = s.xpBoost;
    log("ì €ì¥ ë°ì´í„° ë¶ˆëŸ¬ì˜´");
  }catch(e){
    console.warn("Load failed", e);
  }
}

/* =========================
   ë§µ ë Œë”ë§ (í´ë¦­ìœ¼ë¡œ ì´ë™, ë ˆë²¨ ì œí•œ)
   ========================= */
function renderMap(){
  mapGrid.innerHTML = "";
  areas.forEach((a, idx)=>{
    const node = document.createElement("div");
    node.className = "map-node" + ((playerLv < a.lv) ? " locked" : "");
    node.innerHTML = `<div style="font-weight:800">${a.name}</div><div class="small">Req LV ${a.lv}</div>`;
    node.onclick = ()=>{
      if(playerLv < a.lv){ log(`LV ${a.lv} ì´ìƒì´ ë˜ì–´ì•¼ ì´ë™ ê°€ëŠ¥í•©ë‹ˆë‹¤.`); return; }
      // ì´ë™: ë°”ê¿”ì¹˜ê¸° spawnMonsterê°€ ì§€ì—­ ê¸°ì¤€ìœ¼ë¡œ ëª¬ìŠ¤í„° ì„¸íŒ…í•¨
      areaTextElem.textContent = a.name;
      // make kills a little offset so mobs scale
      spawnMonster(idx);
      log(`ğŸ“ ${a.name} ì§€ì—­ìœ¼ë¡œ ì´ë™í–ˆìŠµë‹ˆë‹¤.`);
    };
    mapGrid.appendChild(node);
  });
}

/* =========================
   ìƒì  ì •ì˜ & ë Œë”ë§
   ========================= */
const shopItems = [
  { id:"atk_boost", label:"ê³µê²©ì˜ ë³´ì„", desc:"ATK +1 (ì˜êµ¬)", price:150, onBuy:()=>{
    atk += 1; log("ğŸ—¡ ê³µê²©ë ¥ +1 íšë“"); updateUI();
  }},
  { id:"mana_pot", label:"ë§ˆë‚˜ ë¬¼ì•½", desc:"MP +50 ì¦‰ì‹œ íšŒë³µ", price:40, onBuy:()=>{
    mp = Math.min(maxMp, mp+50); log("ğŸ· ë§ˆë‚˜ +50"); updateUI();
  }},
  { id:"cool_reduce", label:"ìŠ¤í‚¬ ì—°ë§ˆì„œ", desc:"ëª¨ë“  ìŠ¤í‚¬ ì¿¨ë‹¤ìš´ -1ì´ˆ", price:120, onBuy:()=>{
    Object.values(skillState).forEach(s=> s.cd = Math.max(1, s.cd-1));
    log("ğŸ“š ìŠ¤í‚¬ ì¿¨ë‹¤ìš´ ê°ì†Œ");
  }},
  { id:"xp_boost", label:"XP ë¶€ìŠ¤í„°(30s)", desc:"ê²½í—˜ì¹˜ 2ë°° 30ì´ˆ", price:100, onBuy:()=>{
    xpBoost.active = true; xpBoost.multiplier = 2; xpBoost.endAt = Date.now()+30000;
    log("âœ¨ XP 2ë°° ì ìš© (30s)");
  }},
  { id:"job_ticket", label:"ì „ì§ ì¦ì„œ", desc:"ì¦‰ì‹œ ì „ì§ ê°€ëŠ¥(í•œ ë‹¨ê³„)", price:300, onBuy:()=>{
    // allow immediate jobChange if possible
    if((jobStage===0 && playerLv>=20) || (jobStage===1 && playerLv>=40) || (jobStage===2 && playerLv>=60)){
      jobChange(); log("ğŸŸ ì „ì§ ì¦ì„œ ì‚¬ìš© - ì „ì§ ì™„ë£Œ!");
    } else {
      // if not eligible, refund
      log("â— ì „ì§ ì¡°ê±´ì´ ì•„ë‹™ë‹ˆë‹¤. ì¡°ê±´ ë¯¸ì¶©ì¡±ìœ¼ë¡œ í™˜ë¶ˆë©ë‹ˆë‹¤.");
      coins += 300;
    }
  }},
];

function renderShop(){
  shopGrid.innerHTML = "";
  shopItems.forEach(it=>{
    const div = document.createElement("div");
    div.className = "shop-item";
    div.innerHTML = `<div style="font-weight:800">${it.label}</div>
                     <div class="small">${it.desc}</div>
                     <div style="margin-top:8px;display:flex;justify-content:space-between;align-items:center">
                       <div class="small">ê°€ê²©: ${it.price}ğŸ’°</div>
                       <button class="btn" onclick="buyItem('${it.id}')">êµ¬ë§¤</button>
                     </div>`;
    shopGrid.appendChild(div);
  });
}

function buyItem(id){
  const it = shopItems.find(x=>x.id===id);
  if(!it) return;
  if(coins < it.price){ log("ğŸ’¸ ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤."); if(soundEnabled){ failSound.currentTime=0; failSound.play().catch(()=>{});} return; }
  coins -= it.price;
  it.onBuy();
  if(soundEnabled){ upgradeSound.currentTime=0; upgradeSound.play().catch(()=>{});}
  updateUI();
}

/* =========================
   ëª¬ìŠ¤í„° ìŠ¤í°
   ========================= */
function areaIndex(){
  let idx = 0;
  for(let i=0;i<areas.length;i++) if(playerLv >= areas[i].lv) idx = i;
  return idx;
}

function spawnMonster(forcedArea){
  const a = (typeof forcedArea === "number") ? forcedArea : areaIndex();
  monsterMaxHp = 30 + a*40 + kills*2;
  monsterHp = monsterMaxHp;
  monsterNameElem.textContent = monsters[a][Math.floor(Math.random()*monsters[a].length)];
  areaTextElem.textContent = areas[a].name;
  updateUI();
}

/* =========================
   ì „íˆ¬ / ê³µê²©
   ========================= */
function attack(){
  monsterHp -= atk;
  if(soundEnabled){ hitSound.currentTime=0; hitSound.play().catch(()=>{}); }
  if(monsterHp <= 0){
    if(soundEnabled){ killSound.currentTime=0; killSound.play().catch(()=>{}); }
    kills++;
    const drop = Math.random();
    if(drop < 0.05){
      coins += 100; log("ğŸŒˆ ë¬´ì§€ê°œ ê³¨ë“œ íšë“!!!");
    } else {
      coins += Math.floor((10 + areaIndex()*6) * goldBonus);
    }
    // xp calc with boost
    const baseXp = 5 + areaIndex()*3;
    const mult = xpBoost.active && Date.now() < xpBoost.endAt ? xpBoost.multiplier : 1;
    exp += Math.floor(baseXp * (1 + upgradeLv*0.08 + goldBonus) * mult);
    levelUp();
    spawnMonster();
  }
  updateUI();
}

/* =========================
   ë ˆë²¨ì—… ë¡œì§ (nextExp ì„±ì¥ ì™„í™”)
   ========================= */
function levelUp(){
  let leveled = false;
  while(exp >= nextExp){
    exp -= nextExp;
    playerLv++;
    atk++;
    leveled = true;
    if(soundEnabled){ levelSound.currentTime=0; levelSound.play().catch(()=>{}); }
    log(`ğŸ‰ ë ˆë²¨ì—…! LV ${playerLv}`);
    nextExp = Math.floor(nextExp * 1.3); // ê¸°ì¡´ 1.5 -> 1.3
  }
  if(leveled) updateUI();
}

/* =========================
   ê°•í™”
   ========================= */
function upgrade(){
  const cost = 20 + upgradeLv*6;
  if(coins < cost){ log("ğŸ’¸ ê³¨ë“œ ë¶€ì¡±!"); if(soundEnabled){ failSound.currentTime=0; failSound.play().catch(()=>{});} return; }
  coins -= cost;
  const chance = upgradeLv >= 10 ? 95 : upgradeChance;
  if(Math.random()*100 <= chance){
    upgradeLv++;
    atk += (upgradeLv>=10?2:1);
    upgradeChance = Math.max(10, upgradeChance - 2);
    log("âœ¨ ê°•í™” ì„±ê³µ!");
    if(soundEnabled){ upgradeSound.currentTime=0; upgradeSound.play().catch(()=>{}); }
  } else {
    log("ğŸ’¥ ê°•í™” ì‹¤íŒ¨â€¦");
    if(soundEnabled){ failSound.currentTime=0; failSound.play().catch(()=>{}); }
  }
  updateUI();
}

/* =========================
   ì „ì§ (ë²„íŠ¼)
   ========================= */
function checkJob(){
  if(playerLv>=20 && jobStage===0) jobBtn.style.display="block";
  else if(playerLv>=40 && jobStage===1) jobBtn.style.display="block";
  else if(playerLv>=60 && jobStage===2) jobBtn.style.display="block";
  else jobBtn.style.display="none";
}
function jobChange(){
  if(jobStage===0 && playerLv>=20){ job="âš” ìš°ìœ ì°¸ì¹˜"; atk+=5; jobStage=1; }
  else if(jobStage===1 && playerLv>=40){ job="ğŸ”¥ ì¤€ë¸Œë ˆë“œì—‰ë©ì´"; atk+=10; goldBonus+=0.3; jobStage=2; }
  else if(jobStage===2 && playerLv>=60){ job="ğŸŒŒ ìœ ê¸°ì‚¬"; atk+=20; goldBonus+=0.7; jobStage=3; }
  else { log("ì „ì§ ì¡°ê±´ ë¯¸ì¶©ì¡±"); return; }
  log(`ğŸŒŸ ì „ì§ ì™„ë£Œ! ${job}`);
  if(soundEnabled){ upgradeSound.currentTime=0; upgradeSound.play().catch(()=>{}); }
  updateUI();
}

/* =========================
   ìë™ì‚¬ëƒ¥
   ========================= */
function toggleAuto(){
  autoHunt = !autoHunt;
  if(autoHunt){
    document.getElementById("autoBtn").textContent = "ğŸ¤– ìë™ì‚¬ëƒ¥ ON";
    autoInterval = setInterval(()=> {
      // only attack if monster alive
      if(monsterHp > 0) attack();
    }, 220);
    log("ìë™ì‚¬ëƒ¥ ì‹œì‘");
  } else {
    document.getElementById("autoBtn").textContent = "ğŸ¤– ìë™ì‚¬ëƒ¥ OFF";
    clearInterval(autoInterval); autoInterval = null;
    log("ìë™ì‚¬ëƒ¥ ì¤‘ì§€");
  }
}

/* =========================
   ìŠ¤í‚¬ ì‚¬ìš© (MP ì†Œëª¨ + ì¿¨ë‹¤ìš´)
   ========================= */
function useSkill(id){
  const s = skillState[id];
  const now = Date.now()/1000;
  if(now - s.last < s.cd){ log(`${s.name}ì€(ëŠ”) ì•„ì§ ì¿¨íƒ€ì„ì…ë‹ˆë‹¤.`); return; }
  if(mp < s.mp){ log("MPê°€ ë¶€ì¡±í•©ë‹ˆë‹¤."); return; }

  mp -= s.mp;
  s.last = now;

  // íš¨ê³¼ ì ìš©
  if(id===1){
    // Power Strike: í˜„ì¬ ê³µê²©ë ¥ * 5 ëŒ€ë¯¸ì§€ (ì¹˜ëª…)
    const dmg = atk * 5;
    monsterHp -= dmg;
    log(`ğŸ’¥ POWER STRIKE! ${dmg} ë°ë¯¸ì§€`);
  } else if(id===2){
    // Whirlwind: atk*3
    const dmg = atk * 3;
    monsterHp -= dmg;
    log(`ğŸŒ€ WHIRLWIND! ${dmg} ë°ë¯¸ì§€`);
  }

  // ì‚¬ìš´ë“œ
  if(soundEnabled){ hitSound.currentTime=0; hitSound.play().catch(()=>{}); }

  // ì¿¨ë‹¤ìš´ UI
  startCooldownUI(id);

  if(monsterHp<=0){
    if(soundEnabled){ killSound.currentTime=0; killSound.play().catch(()=>{}); }
    kills++;
    coins += Math.floor((10 + areaIndex()*6) * goldBonus);
    exp += Math.floor((8 + areaIndex()*6) * (1 + upgradeLv*0.1 + goldBonus));
    levelUp();
    spawnMonster();
  }
  updateUI();
}

/* cooldown UI */
function startCooldownUI(id){
  const cdElem = document.getElementById(`skill${id}Cd`);
  const s = skillState[id];
  const total = s.cd;
  cdElem.style.width = "100%";
  let start = Date.now();
  const tick = setInterval(()=>{
    const elapsed = (Date.now() - start)/1000;
    const perc = Math.max(0, (1 - elapsed/total))*100;
    cdElem.style.width = perc + "%";
    if(elapsed >= total){
      clearInterval(tick);
      cdElem.style.width = "0%";
    }
  },100);
}

/* =========================
   MP ì¬ìƒ/XP boost ë§Œë£Œ ì²˜ë¦¬
   ========================= */
setInterval(()=>{
  // mp regen
  if(mp < maxMp){
    mp = Math.min(maxMp, mp + mpRegen);
    updateUI();
  }
  // xp boost ë§Œë£Œ ì²´í‚¹
  if(xpBoost.active && Date.now() >= xpBoost.endAt){
    xpBoost.active = false; xpBoost.multiplier = 1; log("XP ë¶€ìŠ¤í„° ì¢…ë£Œ");
  }
},1000);

/* =========================
   ì¶œì„ì²´í¬
   ========================= */
function checkAttendance(){
  const today = new Date().toISOString().slice(0,10);
  const lastVisit = localStorage.getItem("lastAttendance");
  if(lastVisit !== today){
    coins += 50;
    log("ğŸ ì˜¤ëŠ˜ ì¶œì„ ë³´ìƒ 50ğŸ’° ì§€ê¸‰!");
    localStorage.setItem("lastAttendance", today);
    updateUI();
  } else {
    log("âœ… ì˜¤ëŠ˜ ì¶œì„ ì™„ë£Œ!");
  }
}

/* =========================
   ë¡œê¹… & UI ì—…ë°ì´íŠ¸
   ========================= */
function log(msg){
  const p = document.createElement("div");
  p.textContent = msg;
  logElem.prepend(p);
}

function updateUI(){
  playerLvSpan.textContent = playerLv;
  playerLvSmall.textContent = playerLv;
  atkSpan.textContent = atk;
  coinSpan.textContent = coins;
  expTextSpan.textContent = `${exp}/${nextExp}`;
  upgradeLvSpan.textContent = upgradeLv;
  upgradeCostSpan.textContent = 20 + upgradeLv*6;
  jobTextSpan.textContent = job;
  hpFill.style.width = (monsterMaxHp>0 ? (monsterHp/monsterMaxHp*100) : 0) + "%";
  mpFill.style.width = (mp/maxMp*100) + "%";
  // ì „ì§ ë²„íŠ¼ display
  checkJob();
  // shop/render
  renderMap();
  renderShop();
  save();
}

/* =========================
   ì´ˆê¸°í™”: ë¡œë“œ -> ìŠ¤í° -> UI
   ========================= */
load();
checkAttendance();
spawnMonster();
renderMap();
renderShop();
updateUI();

/* dev helpers */
// window._clear = ()=>{ localStorage.clear(); location.reload(); }
</script>
</body>
</html>
