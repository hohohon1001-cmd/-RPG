<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ìœ ê¸°ì‚¬ RPG â€“ ìµœì¢… ì™„ì„±ë³¸</title>
<style>
:root{
  --card-bg: rgba(10,12,24,0.6);
  --accent: #7c8cff;
  --accent-2:#ff9b9b;
  --glass: rgba(255,255,255,0.04);
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:linear-gradient(180deg,#071027,#020212);font-family:'Segoe UI',sans-serif;color:#e6e8ff}
body{display:flex;align-items:center;justify-content:center;padding:20px}

/* app container */
.app{
  width:100%;max-width:1200px;border-radius:16px;overflow:hidden;
  background:linear-gradient(180deg, rgba(2,6,23,0.6), rgba(1,3,10,0.75));
  box-shadow:0 12px 40px rgba(0,0,0,0.7);
  display:grid;grid-template-columns:320px 1fr;gap:16px;padding:16px;
  backdrop-filter: blur(6px);
}

/* left column */
.left{display:flex;flex-direction:column;gap:12px}
.card{background:var(--card-bg);padding:12px;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,0.4)}
.hud-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
.hud-item{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:10px;border-radius:10px;text-align:center}
.hud-item .label{font-size:12px;color:#bfc7ff}
.hud-item .value{font-weight:800;font-size:18px;margin-top:6px;color:var(--accent)}

/* center monster card */
.center{display:flex;flex-direction:column;gap:12px}
.monster-card{border-radius:14px;padding:18px;background:linear-gradient(180deg, rgba(10,14,30,0.55), rgba(5,7,12,0.55));text-align:center}
.monster-name{font-size:20px;font-weight:800;margin-bottom:8px}
.hp-bar{height:14px;background:#111;border-radius:10px;overflow:hidden}
.hp-fill{height:100%;background:linear-gradient(90deg,#ff3b3b,#ff9b9b);width:100%;transition:width .12s linear}

/* buttons */
.btn{display:inline-block;padding:12px 14px;border-radius:12px;border:none;cursor:pointer;color:white;font-weight:800;background:linear-gradient(90deg,var(--accent),#5b62e8);box-shadow:0 8px 20px rgba(92,97,214,0.12)}
.btn.small{padding:8px 10px;font-size:13px}
.btn.warn{background:linear-gradient(90deg,#ff7b7b,#ffb86b);color:#110f0f}
.btn.job{background:linear-gradient(90deg,#ffd700,#ff4d4d,#9b4dff)}
.btn.auto{background:linear-gradient(90deg,#00ffa6,#00b37a)}

/* right column */
.right{display:flex;flex-direction:column;gap:12px}
.map-list{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
.map-node{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:10px;padding:10px;text-align:center;cursor:pointer}
.map-node.locked{opacity:.45;filter:grayscale(30%);cursor:not-allowed}
.map-node.active{outline:2px solid rgba(124,140,255,0.25);box-shadow:0 8px 18px rgba(124,140,255,0.06)}

/* shop */
.shop-grid{display:grid;grid-template-columns:repeat(1,1fr);gap:8px}
.shop-item{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;background:rgba(255,255,255,0.02)}

/* skills */
.skill-row{display:flex;gap:8px;margin-top:8px}
.skill-btn{flex:1;padding:10px;border-radius:10px;background:linear-gradient(90deg,#ff8b8b,#ffc26f);color:#110;font-weight:800;cursor:pointer;position:relative;overflow:hidden}
.cooldown{position:absolute;left:0;top:0;height:100%;background:rgba(0,0,0,0.45);width:0%;transition:width .2s linear;color:#fff;display:flex;align-items:center;justify-content:center;font-weight:800}

/* log */
.log{height:120px;overflow:auto;padding:8px;border-radius:8px;background:linear-gradient(90deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02));font-size:13px;color:#cfd6ff}

/* responsive */
@media(max-width:900px){.app{grid-template-columns:1fr}.map-list{grid-template-columns:repeat(3,1fr)}}
</style>
</head>
<body>

<div class="app" id="app">
  <!-- LEFT -->
  <div class="left">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div>
          <div class="hud-item" style="display:inline-block;margin-right:8px"><div class="label">LV</div><div class="value" id="playerLv">1</div></div>
          <div class="hud-item" style="display:inline-block"><div class="label">ATK</div><div class="value" id="atk">1</div></div>
        </div>
        <div style="text-align:right">
          <div class="label" style="opacity:.8">ê°•í™”</div>
          <div id="upgradeLv" style="font-weight:800;color:#ffd78e">1</div>
        </div>
      </div>

      <div style="margin-bottom:8px">
        <div class="label" style="color:#bfc7ff">EXP</div>
        <div class="hp-bar" style="height:10px"><div id="expFill" class="hp-fill" style="background:linear-gradient(90deg,#9b8bff,#bfaeff);width:0%"></div></div>
      </div>

      <div style="margin-top:8px">
        <div class="label" style="color:#bfc7ff">HP</div>
        <div class="hp-bar"><div id="hpFill" class="hp-fill" style="width:100%"></div></div>
      </div>

      <div style="margin-top:8px">
        <div class="label" style="color:#bfc7ff">MP</div>
        <div class="hp-bar"><div id="mpFill" class="hp-fill" style="background:linear-gradient(90deg,#4be0ff,#2aa8ff);width:100%"></div></div>
      </div>

      <div style="margin-top:10px;display:flex;gap:8px">
        <button id="upgradeBtn" class="btn" onclick="upgrade()">ğŸ”§ ê°•í™” (<span id="upgradeCost">20</span>)</button>
      </div>
      <div style="margin-top:10px;display:flex;gap:8px">
        <button id="jobBtn" class="btn job" onclick="jobChange()" style="display:none">ğŸ”® ì „ì§</button>
        <button id="autoBtn" class="btn auto" onclick="toggleAuto()">ğŸ¤– ìë™ì‚¬ëƒ¥ OFF</button>
      </div>
      <div style="margin-top:10px">
        <div class="label" style="color:#bfc7ff">ê³¨ë“œ</div>
        <div id="coin" style="font-weight:800;color:#ffd78e">0</div>
      </div>
    </div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong>ì¶œì„ì²´í¬</strong>
        <button class="btn small" onclick="checkAttendance()">ğŸ“… ì¶œì„</button>
      </div>
      <div style="margin-top:8px" id="attendanceMsg" class="small"></div>
    </div>

    <div class="card">
      <strong>ìƒì </strong>
      <div class="shop-grid" id="shopGrid" style="margin-top:8px"></div>
    </div>

  </div>

  <!-- RIGHT -->
  <div class="right">
    <div class="card monster-card">
      <div class="monster-name" id="monsterName">ë©œë‹˜</div>
      <div class="hp-bar"><div id="monsterHpFill" class="hp-fill" style="width:100%"></div></div>

      <div style="display:flex;gap:8px;margin-top:10px">
        <button class="btn" onclick="attack()">âš” ê³µê²©</button>
        <button class="btn small" onclick="spawnMonster()">ìŠ¤í° ë¦¬ì…‹</button>
        <button class="btn small" onclick="spawnBoss()">ë³´ìŠ¤ ì†Œí™˜</button>
      </div>

      <div style="margin-top:12px" class="skill-row">
        <div class="skill-btn" id="skill1Btn" onclick="useSkill(1)">
          POWER STRIKE<br><small class="small">MP 20 Â· CD 6s</small>
          <div class="cooldown" id="skill1Cd"></div>
        </div>
        <div class="skill-btn" id="skill2Btn" onclick="useSkill(2)" style="background:linear-gradient(90deg,#ffd18a,#ff8b8b)">
          WHIRLWIND<br><small class="small">MP 40 Â· CD 12s</small>
          <div class="cooldown" id="skill2Cd"></div>
        </div>
      </div>
    </div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong>ì§€ë„</strong>
        <small style="opacity:.8">í´ë¦­í•˜ë©´ ì´ë™ (ë ˆë²¨ ì¡°ê±´)</small>
      </div>
      <div class="map-list" id="mapGrid" style="margin-top:8px"></div>
    </div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong>ë¡œê·¸</strong>
        <div class="small" id="timeBadge">ì €ì¥ë¨</div>
      </div>
      <div id="log" class="log" style="margin-top:8px">ì—¬ì •ì´ ì‹œì‘ë˜ì—ˆë‹¤â€¦</div>
    </div>
  </div>
</div>

<!-- audio -->
<audio id="hitSound" src="https://assets.mixkit.co/sfx/preview/mixkit-quick-hit-2187.mp3"></audio>
<audio id="killSound" src="https://assets.mixkit.co/sfx/preview/mixkit-video-game-win-2016.mp3"></audio>
<audio id="upgradeSound" src="https://assets.mixkit.co/sfx/preview/mixkit-achievement-bell-600.mp3"></audio>
<audio id="failSound" src="https://assets.mixkit.co/sfx/preview/mixkit-wrong-answer-fail-notification-946.mp3"></audio>
<audio id="levelSound" src="https://assets.mixkit.co/sfx/preview/mixkit-magic-game-win-1949.mp3"></audio>
<audio id="bossSound" src="https://assets.mixkit.co/sfx/preview/mixkit-dramatic-hit-166.mp3"></audio>

<script>
/* =========================
   ì•ˆì „í•œ DOM ìºì‹œ
========================= */
const logElem = document.getElementById("log");
const timeBadge = document.getElementById("timeBadge");
const monsterNameElem = document.getElementById("monsterName");
const monsterHpFill = document.getElementById("monsterHpFill");
const playerLvElem = document.getElementById("playerLv");
const atkElem = document.getElementById("atk");
const coinElem = document.getElementById("coin");
const expFill = document.getElementById("expFill");
const hpFill = document.getElementById("hpFill");
const mpFill = document.getElementById("mpFill");
const upgradeLvElem = document.getElementById("upgradeLv");
const upgradeCostElem = document.getElementById("upgradeCost");
const jobBtn = document.getElementById("jobBtn");
const autoBtn = document.getElementById("autoBtn");
const mapGrid = document.getElementById("mapGrid");
const shopGrid = document.getElementById("shopGrid");
const attendanceMsg = document.getElementById("attendanceMsg");
const skill1Cd = document.getElementById("skill1Cd");
const skill2Cd = document.getElementById("skill2Cd");

/* =========================
   GAME STATE (ì´ˆê¸°ê°’)
========================= */
let coins=0, atk=1, playerLv=1, exp=0, nextExp=10;
let upgradeLv=1, upgradeChance=90;
let job="ë©œë¡œìš°ê¸‰", jobStage=0, goldBonus=1;
let kills=0;

let monsterHp=10, monsterMaxHp=10, currentMap=0;

let mp=100, maxMp=100, mpRegen=1;

let autoHunt=false, autoInterval=null;

let skillState = {
  1: { cd:6, last: -9999, mp:20, name:"POWER STRIKE" },
  2: { cd:12, last: -9999, mp:40, name:"WHIRLWIND" }
};

let xpBoost = { active:false, endAt:0, multiplier:1 };

/* =========================
   MAP & MONSTER DATA (ì‚¬ìš©ì ì§€ì • ì´ë¦„ ìœ ì§€)
========================= */
const areas=[
 {name:"ğŸŒ± ì¼ëª»íƒ€",lv:1, bg:"https://images.unsplash.com/photo-1501785888041-af3ef285b470"},
 {name:"ğŸŒ´ ê¸‰ëª»íƒ€",lv:10, bg:"https://images.unsplash.com/photo-1507525428034-b723cf961d3e"},
 {name:"â„ ìœ ê¸°ì‚¬ì˜ ì°¨ê°€ìš´ ë†ë‹´",lv:20, bg:"https://images.unsplash.com/photo-1482192596544-9eb780fc7f66"},
 {name:"ğŸœ ì‹íƒ",lv:30, bg:"https://images.unsplash.com/photo-1504674900247-0877df9cc836"},
 {name:"ğŸŒ‹ íŒ€ ë‚˜ë¹ ",lv:40, bg:"https://images.unsplash.com/photo-1500530855697-b586d89ba3ee"},
 {name:"ğŸŒŒ ìœ ê¸°ì‚¬ ë””ìŠ¤ì½”ë“œ",lv:50, bg:"https://images.unsplash.com/photo-1518770660439-4636190af475"},
 {name:"ğŸ® ë¯¸1ì¹œë†ˆ ê²Œì„ì¦ˆ",lv:60, bg:"https://images.unsplash.com/photo-1519681393784-d120267933ba"}
];

const monsters=[
 ["ì–´ë ¤ì›Œ í•˜ì‹œëŠ” ë©œë‹˜","ë²¨í‚¤ë‹˜"],
 ["ë˜ ëª»ê¹¨ê³  ìˆëŠ” ë©œë‹˜","ë¨¼ì €ê¹¬ ìš°ì°¸ë‹˜"],
 ["ì™•ì´ ë„˜ì–´ì§€ë©´? í‚¹ì½© ã…‹ã…‹ã…‹","ì•„ë‹ˆ ì‹¤ìˆ˜ë¡œ ë¼ì´ë²Œ ë“¤ì–´ê°"],
 ["ì˜·ì— ë–¨ì–´ì§„ ë°¥í’€","í›„ì‹ìœ¼ë¡  ì¤€ë¸Œë ˆë“œ ì—‰ë©ì´"],
 ["ì§­ ìœ ê¸°ì‚¬","ë©œë‹˜ìœ¼ë¡œ ìœ„ì¥í•œ ì¤€ë¸Œë ˆë“œ"],
 ["ìì¹¼ë‹˜","í‘í™”í•œ ë©œë‹˜","ë³´ìŠ¤: ìœ ê¸°ì‚¬ok"],
 ["ë¯¸1ì¹œ ê°œë°œì","ì•¼ê·¼í•˜ëŠ” ê¸°íšì","ë³´ìŠ¤: ë¯¸1ì¹œë†ˆ ëŒ€í‘œ"]
];

/* =========================
   AUDIO ELEMENTS
========================= */
const hitSound = document.getElementById("hitSound");
const killSound = document.getElementById("killSound");
const upgradeSound = document.getElementById("upgradeSound");
const failSound = document.getElementById("failSound");
const levelSound = document.getElementById("levelSound");
const bossSound = document.getElementById("bossSound");

/* ë¸Œë¼ìš°ì € ì •ì±…: ì²« ìœ ì € í´ë¦­ì‹œ ì‚¬ìš´ë“œ ì´ˆê¸°í™” */
document.body.addEventListener("click", ()=>{
  [hitSound, killSound, upgradeSound, failSound, levelSound, bossSound].forEach(s=>{
    s.volume=0.9; s.play().catch(()=>{}); s.pause(); s.currentTime=0;
  });
  log("ğŸ”Š ì‚¬ìš´ë“œ í™œì„±í™”ë¨");
},{once:true});

/* =========================
   UTIL: ë¡œê·¸
========================= */
function log(txt){
  const t = document.createElement("div");
  t.innerText = txt;
  logElem.prepend(t);
}

/* =========================
   ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸°
========================= */
function save(){
  try{
    const data = {
      coins, atk, playerLv, exp, nextExp,
      upgradeLv, upgradeChance, job, jobStage,
      goldBonus, kills, mp, maxMp, skillState, currentMap
    };
    localStorage.setItem("yugisa_final", JSON.stringify(data));
    localStorage.setItem("yugisa_final_time", String(Date.now()));
    timeBadge.textContent = "ì €ì¥ë¨";
    log("ğŸ’¾ ì €ì¥ ì™„ë£Œ");
  }catch(e){
    console.error(e);
    log("âš  ì €ì¥ ì‹¤íŒ¨");
  }
}
function load(){
  try{
    const raw = localStorage.getItem("yugisa_final");
    if(!raw) return;
    const s = JSON.parse(raw);
    coins = Number(s.coins)||coins;
    atk = Number(s.atk)||atk;
    playerLv = Number(s.playerLv)||playerLv;
    exp = Number(s.exp)||exp;
    nextExp = Number(s.nextExp)||nextExp;
    upgradeLv = Number(s.upgradeLv)||upgradeLv;
    upgradeChance = Number(s.upgradeChance)||upgradeChance;
    job = s.job||job;
    jobStage = Number(s.jobStage)||jobStage;
    goldBonus = Number(s.goldBonus)||goldBonus;
    kills = Number(s.kills)||kills;
    mp = Number(s.mp)||mp;
    maxMp = Number(s.maxMp)||maxMp;
    if(s.skillState) skillState = s.skillState;
    currentMap = Number(s.currentMap)||currentMap;
    log("ğŸ’½ ì €ì¥ ë°ì´í„° ë¶ˆëŸ¬ì˜´");
  }catch(e){
    console.warn("ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨", e);
    log("âš  ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨");
  }
}

/* =========================
   MAP ë Œë”ë§ & ì´ë™
========================= */
function renderMap(){
  mapGrid.innerHTML = "";
  areas.forEach((a, idx)=>{
    const node = document.createElement("div");
    node.className = "map-node" + ((playerLv < a.lv) ? " locked" : "") + ((currentMap===idx) ? " active" : "");
    node.innerHTML = `<div style="font-weight:800">${a.name}</div><div class="small">Req LV ${a.lv}</div>`;
    node.onclick = ()=>{
      if(playerLv < a.lv){ log(`ğŸš« LV ${a.lv} ì´ìƒ ë¼ì•¼ ì´ë™ ê°€ëŠ¥í•©ë‹ˆë‹¤.`); return; }
      currentMap = idx;
      spawnMonster();
      log(`ğŸ“ ${a.name} ì§€ì—­ìœ¼ë¡œ ì´ë™í–ˆìŠµë‹ˆë‹¤.`);
      updateUI();
    };
    mapGrid.appendChild(node);
  });
}

/* =========================
   SHOP ì •ì˜
========================= */
const shopItems = [
  { id:"atk_boost", label:"ê³µê²©ì˜ ë³´ì„", desc:"ATK +1 (ì˜êµ¬)", price:150, onBuy:()=>{
    atk+=1; log("ğŸ—¡ ê³µê²©ë ¥ +1 íšë“");
  }},
  { id:"mana_pot", label:"ë§ˆë‚˜ ë¬¼ì•½", desc:"MP +50 ì¦‰ì‹œ íšŒë³µ", price:40, onBuy:()=>{
    mp = Math.min(maxMp, mp+50); log("ğŸ· ë§ˆë‚˜ +50");
  }},
  { id:"cool_reduce", label:"ìŠ¤í‚¬ ì—°ë§ˆì„œ", desc:"ëª¨ë“  ìŠ¤í‚¬ ì¿¨ë‹¤ìš´ -1ì´ˆ", price:120, onBuy:()=>{
    Object.values(skillState).forEach(s=>s.cd = Math.max(1, s.cd-1));
    log("ğŸ“š ìŠ¤í‚¬ ì¿¨ë‹¤ìš´ ê°ì†Œ");
  }},
  { id:"xp_boost", label:"XP ë¶€ìŠ¤í„°(30s)", desc:"ê²½í—˜ì¹˜ 2ë°° 30ì´ˆ", price:100, onBuy:()=>{
    xpBoost.active=true; xpBoost.multiplier=2; xpBoost.endAt = Date.now()+30000;
    log("âœ¨ XP 2ë°° ì ìš© (30s)");
  }}
];

function renderShop(){
  shopGrid.innerHTML = "";
  shopItems.forEach(it=>{
    const div = document.createElement("div");
    div.className = "shop-item";
    div.innerHTML = `<div><strong>${it.label}</strong><div class="small">${it.desc}</div></div>
                     <div><div class="small">${it.price}ğŸ’°</div><button class="btn small" onclick="buyItem('${it.id}')">êµ¬ë§¤</button></div>`;
    shopGrid.appendChild(div);
  });
}
function buyItem(id){
  const it = shopItems.find(x=>x.id===id);
  if(!it) return;
  if(coins < it.price){ log("ğŸ’¸ ê³¨ë“œ ë¶€ì¡±"); if(failSound) failSound.play().catch(()=>{}); return; }
  coins -= it.price;
  it.onBuy();
  if(upgradeSound) upgradeSound.play().catch(()=>{});
  updateUI();
}

/* =========================
   ëª¬ìŠ¤í„° ìƒì„±/ì „íˆ¬
========================= */
function spawnMonster(){
  const a = currentMap;
  monsterMaxHp = 30 + a*40 + kills*2 + Math.floor(playerLv*2);
  monsterHp = monsterMaxHp;
  const name = monsters[a][Math.floor(Math.random()*monsters[a].length)];
  monsterNameElem.textContent = name;
  // play boss sound if boss in name
  if(name.includes("ë³´ìŠ¤") && bossSound) bossSound.play().catch(()=>{});
  updateUI();
}

function attack(){
  monsterHp -= atk;
  if(hitSound) hitSound.currentTime=0, hitSound.play().catch(()=>{});
  if(monsterHp<=0){
    if(killSound) killSound.currentTime=0, killSound.play().catch(()=>{});
    kills++;
    let drop = Math.random();
    if(drop < 0.05){ coins += 100; log("ğŸŒˆ ë¬´ì§€ê°œ ê³¨ë“œ íšë“!!!"); }
    else coins += Math.floor((10+currentMap*6)*goldBonus);
    const baseXp = 8 + currentMap*6;
    const mult = xpBoost.active && Date.now() < xpBoost.endAt ? xpBoost.multiplier : 1;
    exp += Math.floor(baseXp * (1 + upgradeLv*0.08 + goldBonus) * mult);
    levelUp();
    spawnMonster();
  }
  updateUI();
}

function spawnBoss(){
  const bossName = monsters[currentMap][monsters[currentMap].length-1] || "ë³´ìŠ¤";
  monsterNameElem.textContent = bossName;
  monsterMaxHp = Math.floor(monsterMaxHp * 2.5);
  monsterHp = monsterMaxHp;
  if(bossSound) bossSound.play().catch(()=>{});
  log("ğŸ‘¹ ë³´ìŠ¤ ì†Œí™˜!");
  updateUI();
}

/* =========================
   ë ˆë²¨ì—…
========================= */
function levelUp(){
  while(exp >= nextExp){
    exp -= nextExp;
    playerLv++;
    atk++;
    if(levelSound) levelSound.currentTime=0, levelSound.play().catch(()=>{});
    log(`ğŸ‰ ë ˆë²¨ì—…! LV ${playerLv}`);
    nextExp = Math.floor(nextExp * 1.3);
  }
  // ì „ì§ í™œì„±í™” í‘œì‹œ
  checkJob();
}

/* =========================
   ê°•í™”
========================= */
function upgrade(){
  const cost = 20 + upgradeLv*6;
  if(coins < cost){ log("ğŸ’¸ ê³¨ë“œ ë¶€ì¡±!"); if(failSound) failSound.play().catch(()=>{}); return; }
  coins -= cost;
  const chance = upgradeLv >= 10 ? 95 : upgradeChance;
  if(Math.random()*100 <= chance){
    upgradeLv++;
    atk += (upgradeLv>=10?2:1);
    upgradeChance = Math.max(10, upgradeChance-2);
    if(upgradeSound) upgradeSound.currentTime=0, upgradeSound.play().catch(()=>{});
    log("âœ¨ ê°•í™” ì„±ê³µ!");
  } else {
    if(failSound) failSound.currentTime=0, failSound.play().catch(()=>{});
    log("ğŸ’¥ ê°•í™” ì‹¤íŒ¨â€¦");
  }
  updateUI();
}

/* =========================
   ì „ì§
========================= */
function checkJob(){
  if(playerLv>=20 && jobStage===0) jobBtn.style.display="block";
  else if(playerLv>=40 && jobStage===1) jobBtn.style.display="block";
  else if(playerLv>=60 && jobStage===2) jobBtn.style.display="block";
  else jobBtn.style.display="none";
}
function jobChange(){
  if(jobStage===0 && playerLv>=20){ job="âš” ìš°ìœ ì°¸ì¹˜"; atk+=5; jobStage=1; }
  else if(jobStage===1 && playerLv>=40){ job="ğŸ”¥ ì¤€ë¸Œë ˆë“œì—‰ë©ì´"; atk+=10; goldBonus+=0.3; jobStage=2; }
  else if(jobStage===2 && playerLv>=60){ job="ğŸŒŒ ìœ ê¸°ì‚¬"; atk+=20; goldBonus+=0.7; jobStage=3; }
  else { log("ì „ì§ ì¡°ê±´ ë¯¸ì¶©ì¡±"); return; }
  log(`ğŸŒŸ ì „ì§ ì™„ë£Œ! ${job}`);
  if(upgradeSound) upgradeSound.currentTime=0, upgradeSound.play().catch(()=>{});
  updateUI();
}

/* =========================
   ìë™ì‚¬ëƒ¥
========================= */
function toggleAuto(){
  autoHunt = !autoHunt;
  if(autoHunt){
    autoBtn.textContent = "ğŸ¤– ìë™ì‚¬ëƒ¥ ON";
    autoInterval = setInterval(()=>{ if(monsterHp>0) attack(); }, 220);
    log("ìë™ì‚¬ëƒ¥ ì‹œì‘");
  } else {
    autoBtn.textContent = "ğŸ¤– ìë™ì‚¬ëƒ¥ OFF";
    clearInterval(autoInterval); autoInterval = null;
    log("ìë™ì‚¬ëƒ¥ ì¤‘ì§€");
  }
}

/* =========================
   ìŠ¤í‚¬ (MP, ì¿¨ë‹¤ìš´, UI ì¿¨ë‹¤ìš´)
========================= */
function useSkill(id){
  const s = skillState[id];
  const now = Date.now()/1000;
  if(now - s.last < s.cd){ log(`${s.name} ì¿¨íƒ€ì„ ì¤‘`); return; }
  if(mp < s.mp){ log("MP ë¶€ì¡±"); return; }
  mp -= s.mp;
  s.last = now;

  if(id===1){
    const dmg = atk * 5;
    monsterHp -= dmg;
    log(`ğŸ’¥ ${s.name}! ${dmg} ë°ë¯¸ì§€`);
  } else if(id===2){
    const dmg = atk * 3;
    monsterHp -= dmg;
    log(`ğŸŒ€ ${s.name}! ${dmg} ë°ë¯¸ì§€`);
  }

  if(hitSound) hitSound.currentTime=0, hitSound.play().catch(()=>{});
  startCooldownUI(id);

  if(monsterHp<=0){
    if(killSound) killSound.currentTime=0, killSound.play().catch(()=>{});
    kills++;
    coins += Math.floor((10 + currentMap*6) * goldBonus);
    exp += Math.floor((8 + currentMap*6) * (1 + upgradeLv*0.1 + goldBonus));
    levelUp();
    spawnMonster();
  }
  updateUI();
}

function startCooldownUI(id){
  const cdElem = id===1 ? skill1Cd : skill2Cd;
  const s = skillState[id];
  const total = s.cd;
  cdElem.style.width = "100%";
  let start = Date.now();
  const tick = setInterval(()=>{
    const elapsed = (Date.now() - start)/1000;
    const perc = Math.max(0, (1 - elapsed/total))*100;
    cdElem.style.width = perc + "%";
    if(elapsed >= total) { clearInterval(tick); cdElem.style.width="0%"; }
  },100);
}

/* =========================
   MP ì¬ìƒ / XP booster ë§Œë£Œ
========================= */
setInterval(()=>{
  if(mp < maxMp){ mp = Math.min(maxMp, mp + mpRegen); updateUI(); }
  if(xpBoost.active && Date.now() >= xpBoost.endAt){ xpBoost.active=false; xpBoost.multiplier=1; log("XP ë¶€ìŠ¤í„° ì¢…ë£Œ"); }
},1000);

/* =========================
   ì¶œì„ì²´í¬
========================= */
function checkAttendance(){
  const today = new Date().toISOString().slice(0,10);
  const last = localStorage.getItem("lastAttendance");
  if(last !== today){
    coins += 50;
    localStorage.setItem("lastAttendance", today);
    attendanceMsg.textContent = "ğŸ ì˜¤ëŠ˜ ì¶œì„ ë³´ìƒ 50ğŸ’° ì§€ê¸‰!";
    log("ğŸ ì˜¤ëŠ˜ ì¶œì„ ë³´ìƒ ì§€ê¸‰");
    updateUI();
  } else {
    attendanceMsg.textContent = "âœ… ì˜¤ëŠ˜ ì¶œì„ ì´ë¯¸ ì™„ë£Œ";
  }
}

/* =========================
   ìœ í‹¸: ëª¬ìŠ¤í„° ë¦¬ìŠ¤í° & UI ì—…ë°ì´íŠ¸
========================= */
function spawnMonster(){
  const a = currentMap;
  monsterMaxHp = 30 + a*40 + kills*2 + Math.floor(playerLv*2);
  monsterHp = monsterMaxHp;
  const name = monsters[a][Math.floor(Math.random()*monsters[a].length)];
  monsterNameElem.textContent = name;
  document.body.style.backgroundImage = `url(${areas[currentMap].bg})`;
  updateUI();
}

function updateUI(){
  playerLvElem.textContent = playerLv;
  atkElem.textContent = atk;
  coinElem.textContent = coins;
  upgradeLvElem.textContent = upgradeLv;
  upgradeCostElem.textContent = 20 + upgradeLv*6;
  expFill.style.width = `${Math.min(100, (exp/nextExp*100))}%`;
  monsterHpFill.style.width = `${Math.max(0, (monsterHp/monsterMaxHp*100))}%`;
  hpFill.style.width = `${Math.min(100, (playerLv>0?100:100))}%`; // placeholder for player HP bar visual
  mpFill.style.width = `${Math.min(100, (mp/maxMp*100))}%`;
  checkJob();
  renderMap();
  renderShop();
  save(); // autosave for safety
}

/* =========================
   ì´ˆê¸°í™”: maps, shop ë Œë”, ë¡œë“œ, ìŠ¤í°
========================= */
function renderMap(){
  mapGrid.innerHTML = "";
  areas.forEach((a, idx)=>{
    const div = document.createElement("div");
    div.className = "map-node" + ((playerLv < a.lv) ? " locked" : "") + ((currentMap===idx) ? " active" : "");
    div.innerHTML = `<div style="font-weight:800">${a.name}</div><div class="small">Req LV ${a.lv}</div>`;
    div.onclick = ()=>{
      if(playerLv < a.lv){ log(`LV ${a.lv} ì´ìƒ í•„ìš”`); return; }
      currentMap = idx;
      spawnMonster();
      log(`ì´ë™: ${a.name}`);
    };
    mapGrid.appendChild(div);
  });
}

function renderShop(){ shopGrid.innerHTML=""; shopItems.forEach(it=>{
  const node = document.createElement("div");
  node.className="shop-item";
  node.innerHTML = `<div><strong>${it.label}</strong><div class="small">${it.desc}</div></div>
                    <div><div class="small">${it.price}ğŸ’°</div><button class="btn small" onclick="buyItem('${it.id}')">êµ¬ë§¤</button></div>`;
  shopGrid.appendChild(node);
}); }

/* =========================
   ì‹œì‘ ì‹¤í–‰
========================= */
let currentMap = 0;
load();
renderMap();
renderShop();
spawnMonster();
updateUI();
log("ê²Œì„ ì´ˆê¸°í™” ì™„ë£Œ â€” ì¦ê±°ìš´ í”Œë ˆì´ ë˜ì„¸ìš”!");
</script>
</body>
</html>
