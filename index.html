<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ìœ ê¸°ì‚¬ RPG â€” ì™„ì „íŒ (ìˆ˜ì •)</title>

<!-- ìŠ¤íƒ€ì¼: ê°„ì§€ë‚˜ëŠ” ë°°ê²½ + ë°˜íˆ¬ëª… ì¹´ë“œ -->
<style>
:root{
  --accent:#7c8cff;
  --accent2:#ff9b9b;
  --glass: rgba(255,255,255,0.04);
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Inter, "Segoe UI", Roboto, system-ui, -apple-system; color:#e6e8ff;}
body{
  /* ë¬´ë£Œ ì´ë¯¸ì§€ + ê·¸ë¼ë°ì´ì…˜ */
  background:
    linear-gradient(180deg, rgba(2,6,23,0.55), rgba(1,3,10,0.85)),
    url('https://images.unsplash.com/photo-1519681393784-d120267933ba?auto=format&fit=crop&w=1920&q=80');
  background-size:cover; background-position:center;
  display:flex; align-items:center; justify-content:center; padding:28px;
}
/* ì•± ì»¨í…Œì´ë„ˆ */
.app{
  width:100%; max-width:1160px; border-radius:18px; overflow:hidden;
  background: linear-gradient(180deg, rgba(10,14,26,0.6), rgba(2,6,15,0.6));
  box-shadow: 0 20px 70px rgba(0,0,0,0.7);
  display:grid; grid-template-columns:360px 1fr; gap:18px; padding:18px;
}

/* ì¢Œì¸¡ ì»¬ëŸ¼ */
.left{display:flex;flex-direction:column;gap:12px;}
.card{background:var(--glass); border-radius:12px; padding:12px; box-shadow:0 8px 30px rgba(0,0,0,0.5)}
.hud{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;}
.hud-box{background:linear-gradient(180deg,rgba(255,255,255,0.01),rgba(255,255,255,0.02)); border-radius:10px; padding:8px; text-align:center}
.hud-box .label{font-size:11px; color:#b9c0ff}
.hud-box .value{font-weight:800; font-size:18px; color:var(--accent)}

/* map */
.map-grid{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
.map-node{flex:1 1 30%;min-width:100px;padding:8px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));text-align:center;cursor:pointer;border:1px solid rgba(255,255,255,0.03)}
.map-node.locked{opacity:0.45; filter:grayscale(40%); cursor:not-allowed}

/* monster card */
.monster{border-radius:14px;padding:14px;text-align:center;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); box-shadow:0 10px 30px rgba(0,0,0,0.6)}
.monster .name{font-size:20px;font-weight:800;margin-bottom:8px}
.bar{height:12px;background:#111;border-radius:8px;overflow:hidden}
.bar .fill{height:100%;width:100%;transition:width .12s linear}
.hpfill{background:linear-gradient(90deg,#ff3b3b,#ff9b9b)}
.mpfill{background:linear-gradient(90deg,#6befff,#4db6ff)}

/* buttons */
.btn{display:inline-block;padding:10px 12px;border-radius:10px;border:none;cursor:pointer;color:white;font-weight:800;background:linear-gradient(90deg,var(--accent),#5865f2)}
.btn.secondary{background:linear-gradient(90deg,#2e7bff,#00d4a5)}
.btn.warn{background:linear-gradient(90deg,#ff7b7b,#ffb86b);color:#110f0f}
.btn.small{padding:6px 8px;font-size:13px}
.skill-row{display:flex;gap:8px;margin-top:8px}
.skill-btn{flex:1;padding:8px;border-radius:8px;background:linear-gradient(90deg,#ff8b8b,#ffc26f);color:#110;font-weight:800;cursor:pointer;position:relative;overflow:hidden}
.cooldown{position:absolute;left:0;top:0;height:100%;background:rgba(0,0,0,0.45);width:0%;transition:width .2s linear;color:#fff;display:flex;align-items:center;justify-content:center;font-weight:800}

/* right column */
.right{display:flex;flex-direction:column;gap:12px}
.shop-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-top:8px}
.shop-item{padding:10px;border-radius:8px;background:linear-gradient(90deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02));text-align:center}

/* log */
.log{height:140px;overflow:auto;font-size:13px;padding:8px;border-radius:8px;background:linear-gradient(90deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02))}

/* responsive */
@media(max-width:980px){ .app{grid-template-columns:1fr; padding:12px} .map-node{flex:1 1 40%} }
</style>
</head>
<body>

<div class="app">

  <!-- LEFT -->
  <div class="left">
    <div class="card hud">
      <div class="hud-box"><div class="label">LV</div><div id="playerLv" class="value">1</div></div>
      <div class="hud-box"><div class="label">ì§ì—…</div><div id="jobText" class="value">ë©œë¡œìš°ê¸‰</div></div>
      <div class="hud-box"><div class="label">ATK</div><div id="atk" class="value">1</div></div>
      <div class="hud-box"><div class="label">ê°•í™”</div><div id="upgradeLv" class="value">1</div></div>
      <div class="hud-box"><div class="label">ğŸ’°</div><div id="coin" class="value">0</div></div>
      <div class="hud-box"><div class="label">EXP</div><div id="expText" class="value">0/10</div></div>
      <!-- HUD MP bar -->
      <div style="grid-column:span 3;margin-top:8px">
        <div class="label" style="text-align:left;font-size:12px;color:#b9c0ff">MP</div>
        <div class="bar" style="margin-top:6px"><div id="hudMpFill" class="fill mpfill" style="width:100%"></div></div>
      </div>
    </div>

    <div class="card monster">
      <div id="areaText" style="font-weight:700;margin-bottom:6px">ğŸŒ± ì¼ëª»íƒ€</div>
      <div class="name" id="monsterName">ë©œë‹˜</div>
      <div class="bar" style="margin-bottom:8px"><div id="hpFill" class="fill hpfill" style="width:100%"></div></div>

      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="attackBtn" class="btn">âš” ê³µê²©</button>
        <button id="autoBtn" class="btn secondary">ğŸ¤– ìë™ì‚¬ëƒ¥ OFF</button>
      </div>

      <button id="upgradeBtn" class="btn warn" style="margin-top:8px">ğŸ”§ ê°•í™” (<span id="upgradeCost">20</span>)</button>

      <div style="margin-top:10px;display:flex;justify-content:space-between;align-items:center">
        <div style="flex:1">
          <div class="label" style="font-size:12px;color:#b9c0ff">MP</div>
          <div class="bar" style="margin-top:6px"><div id="mpFill" class="fill mpfill" style="width:100%"></div></div>
        </div>
        <div style="width:110px;text-align:right">
          <div class="label" style="font-size:12px;color:#b9c0ff">Level</div>
          <div id="playerLvSmall" style="font-weight:800">1</div>
        </div>
      </div>
    </div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong>ì§€ë„</strong>
        <span class="small" style="font-size:12px;color:#bfc7ff">í´ë¦­í•´ ì´ë™ (ë ˆë²¨ ì¡°ê±´)</span>
      </div>
      <div id="mapGrid" class="map-grid" style="margin-top:8px"></div>
    </div>

  </div>

  <!-- RIGHT -->
  <div class="right">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong>ìƒì </strong>
        <span class="small" style="font-size:12px;color:#bfc7ff">ê³¨ë“œë¡œ êµ¬ë§¤</span>
      </div>
      <div id="shopGrid" class="shop-grid"></div>
    </div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong>ìŠ¤í‚¬</strong>
        <span class="small" style="font-size:12px;color:#bfc7ff">MP & ì¿¨ë‹¤ìš´</span>
      </div>
      <div class="skill-row" style="margin-top:10px">
        <div id="skill1Btn" class="skill-btn">POWER STRIKE<br><small style="font-size:12px">MP 20 Â· CD 5s</small><div id="skill1Cd" class="cooldown"></div></div>
        <div id="skill2Btn" class="skill-btn" style="background:linear-gradient(90deg,#ffd18a,#ff8b8b)">WHIRLWIND<br><small style="font-size:12px">MP 40 Â· CD 12s</small><div id="skill2Cd" class="cooldown"></div></div>
      </div>

      <div style="margin-top:10px;display:flex;gap:8px">
        <button id="jobBtn" class="btn" style="display:none">ğŸ”® ì „ì§</button>
        <button class="btn secondary" onclick="checkAttendance()">ğŸ“… ì¶œì„ì²´í¬</button>
        <div style="flex:1"></div>
        <div class="badge" id="timeBadge" style="background:rgba(0,0,0,0.25);padding:6px 8px;border-radius:8px;">ì €ì¥ë¨</div>
      </div>
    </div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong>ë¡œê·¸</strong>
      </div>
      <div id="log" class="log" style="margin-top:8px">ê²Œì„ ëŒ€ê¸°ì¤‘...</div>
    </div>
  </div>

</div>

<!-- audio (public sources) -->
<audio id="hitSound" src="https://assets.mixkit.co/sfx/preview/mixkit-quick-hit-2187.mp3"></audio>
<audio id="killSound" src="https://assets.mixkit.co/sfx/preview/mixkit-video-game-win-2016.mp3"></audio>
<audio id="upgradeSound" src="https://assets.mixkit.co/sfx/preview/mixkit-achievement-bell-600.mp3"></audio>
<audio id="failSound" src="https://assets.mixkit.co/sfx/preview/mixkit-wrong-answer-fail-notification-946.mp3"></audio>
<audio id="levelSound" src="https://assets.mixkit.co/sfx/preview/mixkit-magic-game-win-1949.mp3"></audio>
<audio id="bossSound" src="https://assets.mixkit.co/sfx/preview/mixkit-dramatic-hit-166.mp3"></audio>

<script>
/*
  í†µí•© ì™„ì„±ë³¸ ìŠ¤í¬ë¦½íŠ¸ (ì„¤ëª… í¬í•¨)
  - ì›ë³¸ ì´ë¦„/ì§€ì—­ ìœ ì§€
  - ì§€ë„/ìƒì /ìŠ¤í‚¬/ìë™ì‚¬ëƒ¥/ì €ì¥/ì‚¬ìš´ë“œ ëª¨ë‘ ì‘ë™
  - ë¬¸ì œ ìƒê¸°ë©´ ì½˜ì†” ì˜¤ë¥˜ ë©”ì‹œì§€ë¥¼ ë³µì‚¬í•´ì„œ ì¤˜
*/

/* ===========================
   ê²Œì„ ìƒíƒœ (ì´ˆê¸°ê°’)
   =========================== */
let coins = 0;
let atk = 1;
let playerLv = 1;
let exp = 0;
let nextExp = 10;
let upgradeLv = 1;
let upgradeChance = 90;
let job = "ë©œë¡œìš°ê¸‰";
let jobStage = 0;
let goldBonus = 1;
let kills = 0;

let monsterHp = 10, monsterMaxHp = 10;
let mp = 100, maxMp = 100, mpRegen = 1;
let autoHunt = false, autoInterval = null;
let soundEnabled = false;
let currentArea = 0;

// ìŠ¤í‚¬ ìƒíƒœ (cd ì´ˆ, mp ì†Œëª¨)
let skillState = {
  1: { cd:5, last: -9999, mp:20, name:"POWER STRIKE" },
  2: { cd:12, last: -9999, mp:40, name:"WHIRLWIND" }
};

let xpBoost = { active:false, endAt:0, multiplier:1 };

/* ===========================
   ì›ë³¸ ì§€ì—­/ëª¬ìŠ¤í„° (ì´ë¦„ ìœ ì§€)
   =========================== */
const areas = [
  {name:"ğŸŒ± ì¼ëª»íƒ€", lv:1},
  {name:"ğŸŒ´ ê¸‰ëª»íƒ€", lv:10},
  {name:"â„ ìœ ê¸°ì‚¬ì˜ ì°¨ê°€ìš´ ë†ë‹´", lv:20},
  {name:"ğŸœ ì‹íƒ", lv:30},
  {name:"ğŸŒ‹ íŒ€ë‚˜ë¹ ", lv:40},
  {name:"ğŸŒŒ ìœ ê¸°ì‚¬ ë””ìŠ¤ì½”ë“œ", lv:50}
];
const monsters = [
  ["ì–´ë ¤ì›Œ í•˜ì‹œëŠ” ë©œë‹˜","ë²¨í‚¤ë‹˜"],
  ["ë˜ ëª»ê¹¨ê³  ìˆëŠ” ë©œë‹˜","ë¨¼ì €ê¹¬ ìš°ì°¸ë‹˜"],
  ["ì™•ì´ ë„˜ì–´ì§€ë©´? í‚¹ì½© ã…‹ã…‹ã…‹","ì•„ë‹ˆ ì‹¤ìˆ˜ë¡œ ë¼ì´ë²Œ ë“¤ì–´ê°"],
  ["ì˜·ì— ë–¨ì–´ì§„ ë°¥í’€","í›„ì‹ìœ¼ë¡  ì¤€ë¸Œë ˆë“œ ì—‰ë©ì´"],
  ["ì§­ ìœ ê¸°ì‚¬","ë©œë‹˜ìœ¼ë¡œ ìœ„ì¥í•œ ì¤€ë¸Œë ˆë“œ"],
  ["ìì¹¼ë‹˜","í‘í™”í•œ ë©œë‹˜","ë³´ìŠ¤: ìœ ê¸°ì‚¬ok"]
];

/* ===========================
   DOM ìºì‹œ (ì ˆëŒ€ id í‹€ë¦¬ë©´ ì•ˆë¨)
   =========================== */
const playerLvSpan = document.getElementById("playerLv");
const playerLvSmall = document.getElementById("playerLvSmall");
const atkSpan = document.getElementById("atk");
const coinSpan = document.getElementById("coin");
const expTextSpan = document.getElementById("expText");
const upgradeLvSpan = document.getElementById("upgradeLv");
const upgradeCostSpan = document.getElementById("upgradeCost");
const jobTextSpan = document.getElementById("jobText");
const hpFill = document.getElementById("hpFill");
const mpFill = document.getElementById("mpFill");
const hudMpFill = document.getElementById("hudMpFill");
const monsterNameElem = document.getElementById("monsterName");
const areaTextElem = document.getElementById("areaText");
const mapGrid = document.getElementById("mapGrid");
const shopGrid = document.getElementById("shopGrid");
const logElem = document.getElementById("log");
const timeBadge = document.getElementById("timeBadge");

const attackBtn = document.getElementById("attackBtn");
const autoBtn = document.getElementById("autoBtn");
const upgradeBtn = document.getElementById("upgradeBtn");
const jobBtn = document.getElementById("jobBtn");

const skill1Btn = document.getElementById("skill1Btn");
const skill2Btn = document.getElementById("skill2Btn");
const skill1Cd = document.getElementById("skill1Cd");
const skill2Cd = document.getElementById("skill2Cd");

/* audio elements */
const hitSound = document.getElementById("hitSound");
const killSound = document.getElementById("killSound");
const upgradeSound = document.getElementById("upgradeSound");
const failSound = document.getElementById("failSound");
const levelSound = document.getElementById("levelSound");
const bossSound = document.getElementById("bossSound");

/* ===========================
   ë¸Œë¼ìš°ì € ì‚¬ìš´ë“œ ì ê¸ˆ í•´ì œ (ì²« í´ë¦­)
   =========================== */
document.body.addEventListener("click", ()=>{
  [hitSound, killSound, upgradeSound, failSound, levelSound, bossSound].forEach(s=>{
    s.volume = 0.9;
    s.play().catch(()=>{});
    s.pause();
    s.currentTime = 0;
  });
  soundEnabled = true;
  appendLog("ğŸ”Š ì‚¬ìš´ë“œ í™œì„±í™” ì™„ë£Œ!");
},{once:true});

/* ===========================
   ì €ì¥ / ë¶ˆëŸ¬ì˜¤ê¸° (ì•ˆì „)
   =========================== */
function save(){
  try{
    const data = {
      coins, atk, playerLv, exp, nextExp, upgradeLv, upgradeChance, job, jobStage, goldBonus, kills,
      monsterHp, monsterMaxHp, mp, maxMp, mpRegen, skillState, xpBoost, currentArea
    };
    localStorage.setItem("yugisaRPG2", JSON.stringify(data));
    localStorage.setItem("yugisaRPG2_time", String(Date.now()));
    timeBadge.textContent = "ì €ì¥ë¨";
  }catch(e){
    console.error("Save failed:", e);
    appendLog("âš ï¸ ì €ì¥ ì‹¤íŒ¨ (ì½˜ì†” í™•ì¸)");
  }
}

function load(){
  const raw = localStorage.getItem("yugisaRPG2");
  if(!raw) return;
  try{
    const s = JSON.parse(raw);
    // ì•ˆì „ í• ë‹¹ (íƒ€ì… ê°•ì œ)
    coins = Number(s.coins) || coins;
    atk = Number(s.atk) || atk;
    playerLv = Number(s.playerLv) || playerLv;
    exp = Number(s.exp) || exp;
    nextExp = Number(s.nextExp) || nextExp;
    upgradeLv = Number(s.upgradeLv) || upgradeLv;
    upgradeChance = Number(s.upgradeChance) || upgradeChance;
    job = typeof s.job === "string" ? s.job : job;
    jobStage = Number(s.jobStage) || jobStage;
    goldBonus = Number(s.goldBonus) || goldBonus;
    kills = Number(s.kills) || kills;
    monsterHp = Number(s.monsterHp) || monsterHp;
    monsterMaxHp = Number(s.monsterMaxHp) || monsterMaxHp;
    mp = Number(s.mp) || mp;
    maxMp = Number(s.maxMp) || maxMp;
    mpRegen = Number(s.mpRegen) || mpRegen;
    currentArea = Number(s.currentArea) || currentArea;
    if(s.skillState) skillState = s.skillState;
    if(s.xpBoost) xpBoost = s.xpBoost;
    appendLog("ğŸ’¾ ì €ì¥ ë°ì´í„° ë¶ˆëŸ¬ì˜´");
  }catch(e){
    console.warn("Load failed", e);
    appendLog("âš ï¸ ì €ì¥ ë°ì´í„° ì†ìƒ â€” ì´ˆê¸°í™”ë¨");
  }
}

/* ===========================
   ë¡œê·¸ helper
   =========================== */
function appendLog(txt){
  const el = document.createElement("div");
  el.textContent = txt;
  logElem.prepend(el);
}

/* ===========================
   ì§€ë„ ë Œë”ë§ + ì´ë™
   =========================== */
function renderMap(){
  mapGrid.innerHTML = "";
  areas.forEach((a, idx)=>{
    const node = document.createElement("div");
    node.className = "map-node" + (playerLv < a.lv ? " locked" : "");
    node.innerHTML = `<div style="font-weight:700">${a.name}</div><div style="font-size:12px;color:#bfc7ff">Req LV ${a.lv}</div>`;
    node.onclick = ()=>{
      if(playerLv < a.lv){
        appendLog(`ğŸš« LV ${a.lv} ì´ìƒ í•„ìš”`);
        if(soundEnabled) failSound.currentTime=0, failSound.play().catch(()=>{});
        return;
      }
      // ì´ë™
      currentArea = idx;
      spawnMonster(idx);
      appendLog(`ğŸ“ ${a.name} ì§€ì—­ìœ¼ë¡œ ì´ë™í–ˆìŠµë‹ˆë‹¤.`);
      save();
    };
    mapGrid.appendChild(node);
  });
}

/* ===========================
   ìƒì  ì •ì˜ & ë Œë”
   =========================== */
const shopItems = [
  { id:"atk_boost", label:"ê³µê²©ì˜ ë³´ì„", desc:"ATK +1 (ì˜êµ¬)", price:150, onBuy:()=>{
    atk += 1; appendLog("ğŸ—¡ ê³µê²©ë ¥ +1 íšë“"); updateUI(); }},
  { id:"mana_pot", label:"ë§ˆë‚˜ ë¬¼ì•½", desc:"MP +50 ì¦‰ì‹œ íšŒë³µ", price:40, onBuy:()=>{
    mp = Math.min(maxMp, mp+50); appendLog("ğŸ· ë§ˆë‚˜ +50"); updateUI(); }},
  { id:"cool_reduce", label:"ìŠ¤í‚¬ ì—°ë§ˆì„œ", desc:"ëª¨ë“  ìŠ¤í‚¬ ì¿¨ë‹¤ìš´ -1ì´ˆ", price:120, onBuy:()=>{
    Object.values(skillState).forEach(s=> s.cd = Math.max(1, s.cd-1));
    appendLog("ğŸ“š ìŠ¤í‚¬ ì¿¨ë‹¤ìš´ ê°ì†Œ"); }},
  { id:"xp_boost", label:"XP ë¶€ìŠ¤í„°(30s)", desc:"ê²½í—˜ì¹˜ 2ë°° (30s)", price:100, onBuy:()=>{
    xpBoost.active = true; xpBoost.multiplier = 2; xpBoost.endAt = Date.now()+30000;
    appendLog("âœ¨ XP 2ë°° ì ìš© (30s)"); }},
  { id:"job_ticket", label:"ì „ì§ ì¦ì„œ", desc:"ì¦‰ì‹œ ì „ì§ ì¦ì„œ(í•œ ë‹¨ê³„)", price:300, onBuy:()=>{
    if((jobStage===0 && playerLv>=20) || (jobStage===1 && playerLv>=40) || (jobStage===2 && playerLv>=60)){
      jobChange(); appendLog("ğŸŸ ì „ì§ ì¦ì„œ ì‚¬ìš© - ì „ì§ ì™„ë£Œ!"); 
    } else {
      appendLog("â— ì „ì§ ì¡°ê±´ ë¯¸ì¶©ì¡± â€” í™˜ë¶ˆ");
      coins += 300;
    }
  }},
];

function renderShop(){
  shopGrid.innerHTML = "";
  shopItems.forEach(it=>{
    const div = document.createElement("div");
    div.className = "shop-item";
    div.innerHTML = `<div style="font-weight:800">${it.label}</div><div style="font-size:12px;color:#bfc7ff">${it.desc}</div>
      <div style="margin-top:8px;display:flex;justify-content:space-between;align-items:center">
        <div style="font-size:13px">${it.price}ğŸ’°</div>
        <button class="btn small" onclick="buyItem('${it.id}')">êµ¬ë§¤</button>
      </div>`;
    shopGrid.appendChild(div);
  });
}

function buyItem(id){
  const it = shopItems.find(x=>x.id===id);
  if(!it) return;
  if(coins < it.price){ appendLog("ğŸ’¸ ê³¨ë“œ ë¶€ì¡±!"); if(soundEnabled) failSound.currentTime=0, failSound.play().catch(()=>{}); return; }
  coins -= it.price;
  it.onBuy();
  if(soundEnabled){ upgradeSound.currentTime=0; upgradeSound.play().catch(()=>{}); }
  updateUI();
  save();
}

/* ===========================
   ëª¬ìŠ¤í„° ìŠ¤í° (currentArea ìš°ì„ )
   =========================== */
function spawnMonster(forcedArea){
  const a = (typeof forcedArea === "number") ? forcedArea : currentArea;
  monsterMaxHp = 30 + a*40 + kills*2;
  monsterHp = monsterMaxHp;
  const name = monsters[a][Math.floor(Math.random()*monsters[a].length)];
  monsterNameElem.textContent = name;
  areaTextElem.textContent = areas[a].name;
  // ë³´ìŠ¤ ì§€ì ì—ì„œ íŠ¹ìˆ˜ìŒ
  if(a === 5 && name.includes("ë³´ìŠ¤") && soundEnabled){
    bossSound.currentTime=0; bossSound.play().catch(()=>{});
  }
  updateUI();
}

/* ===========================
   ê³µê²© / ì „íˆ¬
   =========================== */
function attack(){
  if(monsterHp <= 0) return;
  monsterHp -= atk;
  if(soundEnabled){ hitSound.currentTime=0; hitSound.play().catch(()=>{}); }
  if(monsterHp <= 0){
    if(soundEnabled){ killSound.currentTime=0; killSound.play().catch(()=>{}); }
    kills++;
    // ê³¨ë“œ ë“œë¡­
    const drop = Math.random();
    if(drop < 0.05){
      coins += 100; appendLog("ğŸŒˆ ë¬´ì§€ê°œ ê³¨ë“œ íšë“!!!");
    } else {
      coins += Math.floor((10 + areaIndex()*6) * goldBonus);
    }
    // xp
    const baseXp = 8 + areaIndex()*6;
    const mult = xpBoost.active && Date.now() < xpBoost.endAt ? xpBoost.multiplier : 1;
    exp += Math.floor(baseXp * (1 + upgradeLv*0.08 + goldBonus) * mult);
    levelUp();
    spawnMonster();
  }
  updateUI();
}

/* ===========================
   ë ˆë²¨ì—…
   =========================== */
function levelUp(){
  let leveled=false;
  while(exp >= nextExp){
    exp -= nextExp;
    playerLv++;
    atk++;
    leveled=true;
    if(soundEnabled){ levelSound.currentTime=0; levelSound.play().catch(()=>{}); }
    appendLog(`ğŸ‰ ë ˆë²¨ì—…! LV ${playerLv}`);
    nextExp = Math.floor(nextExp * 1.3); // ì™„í™”
  }
  if(leveled) updateUI();
}

/* ===========================
   ê°•í™”
   =========================== */
function upgrade(){
  const cost = 20 + upgradeLv*6;
  if(coins < cost){ appendLog("ğŸ’¸ ê³¨ë“œ ë¶€ì¡±!"); if(soundEnabled){ failSound.currentTime=0; failSound.play().catch(()=>{});} return; }
  coins -= cost;
  const chance = upgradeLv >= 10 ? 95 : upgradeChance;
  if(Math.random()*100 <= chance){
    upgradeLv++;
    atk += (upgradeLv>=10?2:1);
    upgradeChance = Math.max(10, upgradeChance - 2);
    appendLog("âœ¨ ê°•í™” ì„±ê³µ!");
    if(soundEnabled){ upgradeSound.currentTime=0; upgradeSound.play().catch(()=>{}); }
  } else {
    appendLog("ğŸ’¥ ê°•í™” ì‹¤íŒ¨â€¦");
    if(soundEnabled){ failSound.currentTime=0; failSound.play().catch(()=>{}); }
  }
  updateUI();
  save();
}

/* ===========================
   ì „ì§
   =========================== */
function checkJob(){
  if(playerLv>=20 && jobStage===0) jobBtn.style.display="inline-block";
  else if(playerLv>=40 && jobStage===1) jobBtn.style.display="inline-block";
  else if(playerLv>=60 && jobStage===2) jobBtn.style.display="inline-block";
  else jobBtn.style.display="none";
}
function jobChange(){
  if(jobStage===0 && playerLv>=20){ job="âš” ìš°ìœ ì°¸ì¹˜"; atk+=5; jobStage=1; }
  else if(jobStage===1 && playerLv>=40){ job="ğŸ”¥ ì¤€ë¸Œë ˆë“œì—‰ë©ì´"; atk+=10; goldBonus+=0.3; jobStage=2; }
  else if(jobStage===2 && playerLv>=60){ job="ğŸŒŒ ìœ ê¸°ì‚¬"; atk+=20; goldBonus+=0.7; jobStage=3; }
  else { appendLog("ì „ì§ ì¡°ê±´ ë¯¸ì¶©ì¡±"); return; }
  appendLog(`ğŸŒŸ ì „ì§ ì™„ë£Œ! ${job}`);
  if(soundEnabled){ upgradeSound.currentTime=0; upgradeSound.play().catch(()=>{}); }
  updateUI();
  save();
}

/* ===========================
   ìë™ì‚¬ëƒ¥
   =========================== */
function toggleAuto(){
  autoHunt = !autoHunt;
  if(autoHunt){
    autoInterval = setInterval(()=> { if(monsterHp>0) attack(); }, 220);
    autoBtn.textContent = "ğŸ¤– ìë™ì‚¬ëƒ¥ ON";
    appendLog("ìë™ì‚¬ëƒ¥ ì‹œì‘");
  } else {
    clearInterval(autoInterval); autoInterval = null;
    autoBtn.textContent = "ğŸ¤– ìë™ì‚¬ëƒ¥ OFF";
    appendLog("ìë™ì‚¬ëƒ¥ ì¤‘ì§€");
  }
}

/* ===========================
   ìŠ¤í‚¬ ì‚¬ìš© (MP, ì¿¨ë‹¤ìš´, UI)
   =========================== */
function useSkill(id){
  const s = skillState[id];
  const now = Date.now()/1000;
  if(now - s.last < s.cd){ appendLog(`${s.name}ì€(ëŠ”) ì•„ì§ ì¿¨íƒ€ì„ì…ë‹ˆë‹¤.`); return; }
  if(mp < s.mp){ appendLog("MPê°€ ë¶€ì¡±í•©ë‹ˆë‹¤."); return; }

  mp -= s.mp;
  s.last = now;
  if(id===1){
    const dmg = atk * 5;
    monsterHp -= dmg;
    appendLog(`ğŸ’¥ POWER STRIKE! ${dmg} ë°ë¯¸ì§€`);
  } else if(id===2){
    const dmg = atk * 3;
    monsterHp -= dmg;
    appendLog(`ğŸŒ€ WHIRLWIND! ${dmg} ë°ë¯¸ì§€`);
  }
  if(soundEnabled){ hitSound.currentTime=0; hitSound.play().catch(()=>{}); }
  startCooldownUI(id);

  if(monsterHp<=0){ if(soundEnabled){ killSound.currentTime=0; killSound.play().catch(()=>{}); } kills++; coins += Math.floor((10 + areaIndex()*6) * goldBonus); exp += Math.floor((8 + areaIndex()*6) * (1 + upgradeLv*0.1 + goldBonus)); levelUp(); spawnMonster(); }
  updateUI();
}

/* cooldown UI */
function startCooldownUI(id){
  const cdElem = document.getElementById(`skill${id}Cd`);
  const s = skillState[id];
  const total = s.cd;
  cdElem.style.width = "100%";
  let start = Date.now();
  const tick = setInterval(()=>{
    const elapsed = (Date.now() - start)/1000;
    const perc = Math.max(0, (1 - elapsed/total))*100;
    cdElem.style.width = perc + "%";
    if(elapsed >= total){ clearInterval(tick); cdElem.style.width = "0%"; }
  },100);
}

/* ===========================
   MP ì¬ìƒ / XP ë¶€ìŠ¤í„° ë§Œë£Œ ì²˜ë¦¬
   =========================== */
setInterval(()=>{
  if(mp < maxMp){ mp = Math.min(maxMp, mp + mpRegen); updateUI(); }
  if(xpBoost.active && Date.now() >= xpBoost.endAt){ xpBoost.active = false; xpBoost.multiplier = 1; appendLog("XP ë¶€ìŠ¤í„° ì¢…ë£Œ"); }
},1000);

/* ===========================
   ì¶œì„ì²´í¬
   =========================== */
function checkAttendance(){
  const today = new Date().toISOString().slice(0,10);
  const lastVisit = localStorage.getItem("lastAttendance");
  if(lastVisit !== today){
    coins += 50;
    appendLog("ğŸ ì˜¤ëŠ˜ ì¶œì„ ë³´ìƒ 50ğŸ’° ì§€ê¸‰!");
    localStorage.setItem("lastAttendance", today);
    updateUI();
    save();
  } else appendLog("âœ… ì˜¤ëŠ˜ ì¶œì„ ì™„ë£Œ!");
}

/* ===========================
   í—¬í¼: areaIndex() (currentArea ìš°ì„ )
   =========================== */
function areaIndex(){ return currentArea; }

/* ===========================
   UI ì—…ë°ì´íŠ¸ (ëª¨ë“  í‘œì‹œ ê°±ì‹ )
   =========================== */
function updateUI(){
  playerLvSpan.textContent = playerLv;
  playerLvSmall.textContent = playerLv;
  atkSpan.textContent = atk;
  coinSpan.textContent = coins;
  expTextSpan.textContent = `${exp}/${nextExp}`;
  upgradeLvSpan.textContent = upgradeLv;
  upgradeCostSpan.textContent = 20 + upgradeLv*6;
  jobTextSpan.textContent = job;
  hpFill.style.width = (monsterMaxHp>0 ? (monsterHp/monsterMaxHp*100) : 0) + "%";
  mpFill.style.width = (mp/maxMp*100) + "%";
  hudMpFill.style.width = (mp/maxMp*100) + "%";
  checkJob();
  renderMap();
  renderShop();
  save();
}

/* ===========================
   ë Œë”: ë§µ / ìƒì 
   =========================== */
function renderMap(){
  mapGrid.innerHTML = "";
  areas.forEach((a, idx)=>{
    const node = document.createElement("div");
    node.className = "map-node" + (playerLv < a.lv ? " locked" : "");
    node.innerHTML = `<div style="font-weight:700">${a.name}</div><div style="font-size:12px;color:#bfc7ff">Req LV ${a.lv}</div>`;
    node.onclick = ()=>{
      if(playerLv < a.lv){ appendLog(`ğŸš« LV ${a.lv} ì´ìƒ í•„ìš”`); if(soundEnabled) failSound.currentTime=0, failSound.play().catch(()=>{}); return; }
      currentArea = idx;
      spawnMonster(idx);
      appendLog(`ğŸ“ ${a.name} ì§€ì—­ìœ¼ë¡œ ì´ë™í–ˆìŠµë‹ˆë‹¤.`);
      save();
    };
    mapGrid.appendChild(node);
  });
}

function renderShop(){
  shopGrid.innerHTML = "";
  shopItems.forEach(it=>{
    const div = document.createElement("div");
    div.className = "shop-item";
    div.innerHTML = `<div style="font-weight:800">${it.label}</div><div style="font-size:12px;color:#bfc7ff">${it.desc}</div>
      <div style="margin-top:8px;display:flex;justify-content:space-between;align-items:center">
        <div style="font-size:13px">${it.price}ğŸ’°</div>
        <button class="btn small" onclick="buyItem('${it.id}')">êµ¬ë§¤</button>
      </div>`;
    shopGrid.appendChild(div);
  });
}

/* ===========================
   ì´ˆê¸°í™”: ì´ë²¤íŠ¸ ë°”ì¸ë”© + ë¡œë“œ + ì‹œì‘
   =========================== */
function wireEvents(){
  // ë²„íŠ¼ ë°”ì¸ë”©
  attackBtn.onclick = attack;
  autoBtn.onclick = toggleAuto;
  upgradeBtn.onclick = upgrade;
  jobBtn.onclick = jobChange;
  skill1Btn.onclick = ()=>useSkill(1);
  skill2Btn.onclick = ()=>useSkill(2);

  // ì•ˆì „ì¥ì¹˜: ì½˜ì†”ì—ì„œ í˜¸ì¶œ ê°€ëŠ¥
  window._forceSpawn = spawnMonster;
}

function init(){
  try{ load(); }catch(e){ console.warn("load failed", e); }
  wireEvents();
  renderMap();
  renderShop();
  spawnMonster();
  updateUI();
  appendLog("ê²Œì„ ì´ˆê¸°í™” ì™„ë£Œ â€” ì¦ê²œ!");
}

/* ===========================
   ì‹¤í–‰
   =========================== */
init();

</script>
</body>
</html>
