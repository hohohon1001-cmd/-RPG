<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ìœ ê¸°ì‚¬ RPG â€” í†µí•©íŒ (ë­í‚¹ í¬í•¨)</title>
<style>
:root{--accent:#7c8cff;--accent2:#ff9b9b;--glass:rgba(255,255,255,0.04)}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Inter, "Segoe UI", Roboto, system-ui;color:#e6e8ff}
body{
  background: linear-gradient(180deg, rgba(3,6,15,0.6), rgba(0,0,0,0.85)),
    url('https://images.unsplash.com/photo-1519681393784-d120267933ba?auto=format&fit=crop&w=1920&q=80');
  background-size:cover;background-position:center;display:flex;align-items:center;justify-content:center;padding:20px;
}
.app{width:100%;max-width:1180px;border-radius:16px;overflow:hidden;background:linear-gradient(180deg, rgba(2,6,23,0.55), rgba(1,3,10,0.7));box-shadow:0 20px 60px rgba(0,0,0,0.7);display:grid;grid-template-columns:380px 1fr;gap:16px;padding:16px;}
.card{background:var(--glass);border-radius:12px;padding:12px;box-shadow:0 8px 24px rgba(0,0,0,0.5)}
.hud{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:8px}
.hud-box{background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02));padding:8px;border-radius:10px;text-align:center}
.hud-box .label{font-size:12px;color:#bfc7ff}
.hud-box .value{font-weight:800;font-size:18px;color:var(--accent);margin-top:4px}

.monster{border-radius:14px;padding:12px;text-align:center}
.monster .name{font-weight:900;font-size:20px;margin-bottom:6px}
.bar{height:12px;background:#111;border-radius:8px;overflow:hidden}
.fill{height:100%;transition:width .12s linear}
.hp{background:linear-gradient(90deg,#ff3b3b,#ff9b9b)}
.mp{background:linear-gradient(90deg,#6befff,#4db6ff)}

.row{display:flex;gap:8px;align-items:center}
.col{display:flex;flex-direction:column;gap:8px}

.map-grid{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
.map-node{flex:1 1 30%;min-width:100px;padding:10px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));text-align:center;cursor:pointer;border:1px solid rgba(255,255,255,0.03)}
.map-node.locked{opacity:0.45;filter:grayscale(40%);cursor:not-allowed}

.shop-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-top:8px}
.shop-item{padding:8px;border-radius:10px;background:linear-gradient(90deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02));text-align:center}

.skill-row{display:flex;gap:8px}
.skill-btn{flex:1;padding:10px;border-radius:10px;background:linear-gradient(90deg,#ffd18a,#ff8b8b);color:#110;font-weight:800;cursor:pointer;position:relative;overflow:hidden}
.cooldown{position:absolute;left:0;top:0;height:100%;background:rgba(0,0,0,0.45);width:0%;transition:width .2s linear;color:#fff;display:flex;align-items:center;justify-content:center;font-weight:800}

.traits{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-top:8px}
.trait{padding:8px;border-radius:8px;background:linear-gradient(90deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02));text-align:center}

.artifacts{display:flex;gap:8px;margin-top:8px}
.art-slot{padding:8px;border-radius:8px;background:linear-gradient(90deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02));text-align:center;min-width:80px}

.log{height:160px;overflow:auto;padding:8px;border-radius:8px;background:linear-gradient(90deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02));font-size:13px}

.badge{background:rgba(0,0,0,0.25);padding:6px 8px;border-radius:10px;font-weight:700;color:#fff}
.small{font-size:12px;color:#bfc7ff}
.btn{padding:10px;border-radius:10px;border:none;cursor:pointer;font-weight:800;background:linear-gradient(90deg,var(--accent),#5865f2);color:white}
.btn.secondary{background:linear-gradient(90deg,#2e7bff,#00d4a5)}
.btn.warn{background:linear-gradient(90deg,#ff7b7b,#ffb86b);color:#120f0f}
.btn.small{padding:6px 8px;font-size:13px}

.modal { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,0.7); z-index:999; }
.modal-box{width:90%;max-width:520px;background:linear-gradient(180deg,#111428,#07102a);padding:14px;border-radius:12px;color:#e6e8ff}
.rank-row{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid rgba(255,255,255,0.04);font-size:14px}

@media(max-width:980px){ .app{grid-template-columns:1fr} .map-node{flex:1 1 45%} }
</style>
</head>
<body>
<div class="app">

  <!-- LEFT BLOCK -->
  <div class="col">
    <div class="card hud">
      <div class="hud-box"><div class="label">LV</div><div id="playerLv" class="value">1</div></div>
      <div class="hud-box"><div class="label">ì§ì—…</div><div id="jobText" class="value">ë©œë¡œìš°ê¸‰</div></div>
      <div class="hud-box"><div class="label">ATK</div><div id="atk" class="value">1</div></div>
      <div class="hud-box"><div class="label">ê°•í™”</div><div id="upgradeLv" class="value">1</div></div>
      <div class="hud-box"><div class="label">ğŸ’°</div><div id="coin" class="value">0</div></div>
      <div class="hud-box"><div class="label">EXP</div><div id="expText" class="value">0/10</div></div>
      <div style="grid-column:span 3;margin-top:8px">
        <div class="small">MP</div>
        <div class="bar" style="margin-top:6px"><div id="hudMpFill" class="fill mp" style="width:100%"></div></div>
      </div>
    </div>

    <div class="card monster">
      <div id="areaText" style="font-weight:700;margin-bottom:6px">ğŸŒ± ì¼ëª»íƒ€</div>
      <div class="name" id="monsterName">ë©œë‹˜</div>
      <div class="bar" style="margin-bottom:8px"><div id="hpFill" class="fill hp" style="width:100%"></div></div>

      <div class="row" style="margin-top:8px">
        <button id="attackBtn" class="btn">âš” ê³µê²©</button>
        <button id="autoBtn" class="btn secondary">ğŸ¤– ìë™ì‚¬ëƒ¥ OFF</button>
      </div>

      <button id="upgradeBtn" class="btn warn" style="margin-top:8px">ğŸ”§ ê°•í™” (<span id="upgradeCost">20</span>ğŸ’°)</button>

      <div style="margin-top:10px;display:flex;justify-content:space-between;align-items:center">
        <div style="flex:1">
          <div class="small">MP</div>
          <div class="bar" style="margin-top:6px"><div id="mpFill" class="fill mp" style="width:100%"></div></div>
        </div>
        <div style="width:110px;text-align:right">
          <div class="small">Level</div>
          <div id="playerLvSmall" style="font-weight:800">1</div>
        </div>
      </div>
    </div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong>ì§€ë„</strong><span class="small">í´ë¦­í•˜ë©´ ì´ë™ (ë ˆë²¨ í•„ìš”)</span>
      </div>
      <div id="mapGrid" class="map-grid"></div>
    </div>

  </div>

  <!-- RIGHT BLOCK -->
  <div class="col">
    <div class="card" style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <strong>ìƒì </strong><span class="small" style="margin-left:8px">ê³¨ë“œë¡œ êµ¬ë§¤</span>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <input id="playerName" placeholder="ì´ë¦„(ë­í‚¹ìš©)" style="padding:6px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:#fff" />
        <button id="rankingOpenBtn" class="btn small">ğŸ† ë­í‚¹</button>
        <div class="badge" id="timeBadge">ì €ì¥ë¨</div>
      </div>
    </div>
    <div id="shopGrid" class="card shop-grid"></div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong>ìŠ¤í‚¬</strong><span class="small">MP Â· ì¿¨ë‹¤ìš´</span>
      </div>
      <div class="skill-row" style="margin-top:10px">
        <div id="skill1Btn" class="skill-btn">POWER STRIKE<br><small class="small">MP 20 Â· CD 5s</small><div id="skill1Cd" class="cooldown"></div></div>
        <div id="skill2Btn" class="skill-btn" style="background:linear-gradient(90deg,#ffd18a,#ff8b8b)">WHIRLWIND<br><small class="small">MP 40 Â· CD 12s</small><div id="skill2Cd" class="cooldown"></div></div>
      </div>
      <div style="margin-top:10px;display:flex;gap:8px;align-items:center">
        <button id="jobBtn" class="btn" style="display:none">ğŸ”® ì „ì§</button>
        <button class="btn secondary" onclick="checkAttendance()">ğŸ“… ì¶œì„ì²´í¬</button>
        <div style="flex:1"></div>
        <div id="bossBtnContainer"></div>
      </div>
    </div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center"><strong>íŠ¹ì„± (í¬ì¸íŠ¸: <span id="traitPoints">0</span>)</strong><span class="small">ë ˆë²¨ì—… ì‹œ í¬ì¸íŠ¸</span></div>
      <div id="traits" class="traits"></div>
    </div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center"><strong>ìœ ë¬¼ ìŠ¬ë¡¯</strong><span class="small">ì¥ì°©ìœ¼ë¡œ ë³´ë„ˆìŠ¤</span></div>
      <div id="artifacts" class="artifacts"></div>
    </div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center"><strong>ë„ê°</strong><span class="small">ì²˜ì¹˜ ìˆ˜</span></div>
      <div id="bestiary" style="margin-top:8px" class="small"></div>
    </div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center"><strong>ë¡œê·¸</strong></div>
      <div id="log" class="log" style="margin-top:8px">ê²Œì„ ì´ˆê¸°í™” ì¤‘â€¦</div>
    </div>
  </div>

</div>

<!-- Ranking modal -->
<div id="rankingModal" style="display:none" class="modal">
  <div class="modal-box">
    <h3>ğŸ† ë­í‚¹ TOP 10</h3>
    <div id="rankingList" style="margin-top:8px"></div>
    <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end">
      <button class="btn small" onclick="closeRanking()">ë‹«ê¸°</button>
    </div>
  </div>
</div>

<!-- audio -->
<audio id="hitSound" src="https://assets.mixkit.co/sfx/preview/mixkit-quick-hit-2187.mp3"></audio>
<audio id="killSound" src="https://assets.mixkit.co/sfx/preview/mixkit-video-game-win-2016.mp3"></audio>
<audio id="upgradeSound" src="https://assets.mixkit.co/sfx/preview/mixkit-achievement-bell-600.mp3"></audio>
<audio id="failSound" src="https://assets.mixkit.co/sfx/preview/mixkit-wrong-answer-fail-notification-946.mp3"></audio>
<audio id="levelSound" src="https://assets.mixkit.co/sfx/preview/mixkit-magic-game-win-1949.mp3"></audio>
<audio id="bossSound" src="https://assets.mixkit.co/sfx/preview/mixkit-dramatic-hit-166.mp3"></audio>

<script>
/* ===========================
  í†µí•© ê²Œì„ ìŠ¤í¬ë¦½íŠ¸ + ë­í‚¹
  =========================== */

/* ê¸°ë³¸ ìƒíƒœ */
let coins=0, atk=1, playerLv=1, exp=0, nextExp=10;
let upgradeLv=1, upgradeChance=90, job="ë©œë¡œìš°ê¸‰", jobStage=0, goldBonus=1, kills=0;
let monsterHp=10, monsterMaxHp=10;
let mp=100, maxMp=100, mpRegen=1;
let autoHunt=false, autoInterval=null;
let soundEnabled=false;
let currentArea=0;
let traitPoints=0;

let skillState={
  1:{cd:5,last:-9999,mp:20,name:"POWER STRIKE",level:1},
  2:{cd:12,last:-9999,mp:40,name:"WHIRLWIND",level:1}
};
let xpBoost={active:false,endAt:0,multiplier:1};
let bossCooldown=1000*60*60*6, bossLast=0;
let artifacts=[null,null,null];
let bestiary={};

/* trait defs (ê°„ë‹¨ ì ìš© í•¨ìˆ˜) */
const traitDefs=[
  {id:'t1',name:'ê³µê²©ì˜ ë³¸ëŠ¥',desc:'ê³µê²©ë ¥ +5%',apply:(m)=>m.atkMult=(m.atkMult||1)*1.05},
  {id:'t2',name:'ê°•í™” ìˆ™ë ¨',desc:'ê°•í™” ì„±ê³µ í™•ë¥  +2%',apply:(m)=>m.upgradeChanceMod=(m.upgradeChanceMod||0)+2},
  {id:'t3',name:'ì¬ìˆ˜ ì¢‹ì€ ê³¨ë“œ',desc:'ê³¨ë“œ +10%',apply:(m)=>m.goldMult=(m.goldMult||1)*1.10},
  {id:'t4',name:'ìŠ¤í‚¬ ì§‘ì¤‘',desc:'MP ì†Œëª¨ -5%',apply:(m)=>m.mpCostMult=(m.mpCostMult||1)*0.95},
  {id:'t5',name:'ìë™ íš¨ìœ¨',desc:'ìë™ ì†ë„ +10%',apply:(m)=>m.autoSpeed=(m.autoSpeed||1)*0.9},
  {id:'t6',name:'ê²½í—˜ì˜ ë¶€ì ',desc:'ê²½í—˜ì¹˜ +10%',apply:(m)=>m.xpMult=(m.xpMult||1)*1.10}
];

/* ì§€ì—­/ëª¬ìŠ¤í„° (ì›ë³¸ ìœ ì§€) */
const areas=[
  {name:"ğŸŒ± ì¼ëª»íƒ€",lv:1},{name:"ğŸŒ´ ê¸‰ëª»íƒ€",lv:10},{name:"â„ ìœ ê¸°ì‚¬ì˜ ì°¨ê°€ìš´ ë†ë‹´",lv:20},
  {name:"ğŸœ ì‹íƒ",lv:30},{name:"ğŸŒ‹ íŒ€ë‚˜ë¹ ",lv:40},{name:"ğŸŒŒ ìœ ê¸°ì‚¬ ë””ìŠ¤ì½”ë“œ",lv:50}
];
const monsters=[
  ["ì–´ë ¤ì›Œ í•˜ì‹œëŠ” ë©œë‹˜","ë²¨í‚¤ë‹˜"],
  ["ë˜ ëª»ê¹¨ê³  ìˆëŠ” ë©œë‹˜","ë¨¼ì €ê¹¬ ìš°ì°¸ë‹˜"],
  ["ì™•ì´ ë„˜ì–´ì§€ë©´? í‚¹ì½© ã…‹ã…‹ã…‹","ì•„ë‹ˆ ì‹¤ìˆ˜ë¡œ ë¼ì´ë²Œ ë“¤ì–´ê°"],
  ["ì˜·ì— ë–¨ì–´ì§„ ë°¥í’€","í›„ì‹ìœ¼ë¡  ì¤€ë¸Œë ˆë“œ ì—‰ë©ì´"],
  ["ì§­ ìœ ê¸°ì‚¬","ë©œë‹˜ìœ¼ë¡œ ìœ„ì¥í•œ ì¤€ë¸Œë ˆë“œ"],
  ["ìì¹¼ë‹˜","í‘í™”í•œ ë©œë‹˜","ë³´ìŠ¤: ìœ ê¸°ì‚¬ok"]
];
/* ===== ëª¨ë°”ì¼ ===== */
@media (max-width: 768px){
  .container{
    transform: scale(0.85);
    transform-origin: top center;
  }

  .hud{
    grid-template-columns: repeat(3, 1fr);
    gap:6px;
  }

  .hud-box{
    font-size:10px;
    padding:4px 0;
    border-radius:14px;
  }

  .hud-box span{
    font-size:13px;
  }

  .btn{
    padding:10px;
    font-size:13px;
    border-radius:16px;
  }

  .monster{
    padding:20px 12px;
  }

  .monster-name{
    font-size:18px;
  }

  .log{
    font-size:12px;
  }
  }
  /* ===== ê¸°ë³¸ (PC) ===== */
.container{
  width:95%;
  max-width:540px;
  background:linear-gradient(180deg,#1a1d2b,#0b0d15);
  border-radius:30px;
  padding:18px;
  box-shadow:0 0 60px rgba(0,0,0,.95);

  transform: scale(1);
  transform-origin: top center;
}
/* shop + artifacts pool */
const shopItems=[
  {id:'atk_boost',label:'ê³µê²©ì˜ ë³´ì„',desc:'ATK +1',price:150,onBuy:()=>{atk+=1;appendLog("ğŸ—¡ ê³µê²©ë ¥ +1 íšë“");}},
  {id:'mana_pot',label:'ë§ˆë‚˜ ë¬¼ì•½',desc:'MP +50',price:40,onBuy:()=>{mp=Math.min(maxMp,mp+50);appendLog("ğŸ· ë§ˆë‚˜ +50");}},
  {id:'cool_reduce',label:'ìŠ¤í‚¬ ì—°ë§ˆì„œ',desc:'ìŠ¤í‚¬ CD -1s',price:120,onBuy:()=>{Object.values(skillState).forEach(s=>s.cd=Math.max(1,s.cd-1));appendLog("ğŸ“š ìŠ¤í‚¬ ì¿¨ê°");}},
  {id:'xp_boost',label:'XP ë¶€ìŠ¤í„°(30s)',desc:'ê²½í—˜ì¹˜ 2ë°° 30s',price:100,onBuy:()=>{xpBoost.active=true;xpBoost.multiplier=2;xpBoost.endAt=Date.now()+30000;appendLog("âœ¨ XP 2ë°° (30s)");}}
];
const artifactPool=[
  {id:'a1',name:'ê²½í—˜ì˜ ë°˜ì§€',desc:'EXP +15%',apply:(m)=>m.xpMult=(m.xpMult||1)*1.15},
  {id:'a2',name:'ë§ˆë‚˜ì„',desc:'MP íšŒë³µ +1/s',apply:(m)=>m.mpRegenAdd=(m.mpRegenAdd||0)+1},
  {id:'a3',name:'ê¸ˆí™” íŒŒìš°ì¹˜',desc:'ê³¨ë“œ +20%',apply:(m)=>m.goldMult=(m.goldMult||1)*1.2}
];

/* DOM ìºì‹œ */
const playerLvSpan=document.getElementById("playerLv");
const playerLvSmall=document.getElementById("playerLvSmall");
const atkSpan=document.getElementById("atk");
const coinSpan=document.getElementById("coin");
const expTextSpan=document.getElementById("expText");
const upgradeLvSpan=document.getElementById("upgradeLv");
const upgradeCostSpan=document.getElementById("upgradeCost");
const jobTextSpan=document.getElementById("jobText");
const hpFill=document.getElementById("hpFill");
const mpFill=document.getElementById("mpFill");
const hudMpFill=document.getElementById("hudMpFill");
const monsterNameElem=document.getElementById("monsterName");
const areaTextElem=document.getElementById("areaText");
const mapGrid=document.getElementById("mapGrid");
const shopGrid=document.getElementById("shopGrid");
const logElem=document.getElementById("log");
const timeBadge=document.getElementById("timeBadge");
const attackBtn=document.getElementById("attackBtn");
const autoBtn=document.getElementById("autoBtn");
const upgradeBtn=document.getElementById("upgradeBtn");
const jobBtn=document.getElementById("jobBtn");
const skill1Btn=document.getElementById("skill1Btn");
const skill2Btn=document.getElementById("skill2Btn");
const skill1Cd=document.getElementById("skill1Cd");
const skill2Cd=document.getElementById("skill2Cd");
const traitsDiv=document.getElementById("traits");
const artifactsDiv=document.getElementById("artifacts");
const merchantBtn=document.getElementById("merchantBtn");
const bossBtnContainer=document.getElementById("bossBtnContainer");
const bestiaryDiv=document.getElementById("bestiary");
const rankingOpenBtn=document.getElementById("rankingOpenBtn");
const rankingModal=document.getElementById("rankingModal");
const rankingList=document.getElementById("rankingList");
const playerNameInput=document.getElementById("playerName");

/* audio */
const hitSound=document.getElementById("hitSound");
const killSound=document.getElementById("killSound");
const upgradeSound=document.getElementById("upgradeSound");
const failSound=document.getElementById("failSound");
const levelSound=document.getElementById("levelSound");
const bossSound=document.getElementById("bossSound");

/* ì‚¬ìš´ë“œ unlock */
document.body.addEventListener("click", ()=>{
  [hitSound,killSound,upgradeSound,failSound,levelSound,bossSound].forEach(s=>{s.volume=0.9;s.play().catch(()=>{});s.pause();s.currentTime=0;});
  soundEnabled=true; appendLog("ğŸ”Š ì‚¬ìš´ë“œ í™œì„±í™”");
},{once:true});
/* ===== ëª¨ë°”ì¼ ===== */
@media (max-width: 768px){
  .container{
    transform: scale(0.85);
    transform-origin: top center;
  }

  .hud{
    grid-template-columns: repeat(3, 1fr);
    gap:6px;
  }

  .hud-box{
    font-size:10px;
    padding:4px 0;
    border-radius:14px;
  }

  .hud-box span{
    font-size:13px;
  }

  .btn{
    padding:10px;
    font-size:13px;
    border-radius:16px;
  }

  .monster{
    padding:20px 12px;
  }

  .monster-name{
    font-size:18px;
  }

  .log{
    font-size:12px;
  }
  }
/* ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸° */
function save(){
  try{
    const data={coins,atk,playerLv,exp,nextExp,upgradeLv,upgradeChance,job,jobStage,goldBonus,kills,monsterHp,monsterMaxHp,mp,maxMp,mpRegen,skillState,xpBoost,currentArea,traitPoints,artifacts,bestiary,bossLast};
    localStorage.setItem("yugisaRPG2",JSON.stringify(data));
    localStorage.setItem("yugisaRPG2_time",String(Date.now()));
    timeBadge.textContent="ì €ì¥ë¨";
  }catch(e){console.error(e);appendLog("âš  ì €ì¥ ì‹¤íŒ¨")}
}
function load(){
  const raw=localStorage.getItem("yugisaRPG2"); if(!raw) return;
  try{
    const s=JSON.parse(raw);
    coins=Number(s.coins)||coins; atk=Number(s.atk)||atk; playerLv=Number(s.playerLv)||playerLv; exp=Number(s.exp)||exp; nextExp=Number(s.nextExp)||nextExp;
    upgradeLv=Number(s.upgradeLv)||upgradeLv; upgradeChance=Number(s.upgradeChance)||upgradeChance; job=s.job||job; jobStage=Number(s.jobStage)||jobStage;
    goldBonus=Number(s.goldBonus)||goldBonus; kills=Number(s.kills)||kills; monsterHp=Number(s.monsterHp)||monsterHp; monsterMaxHp=Number(s.monsterMaxHp)||monsterMaxHp;
    mp=Number(s.mp)||mp; maxMp=Number(s.maxMp)||maxMp; mpRegen=Number(s.mpRegen)||mpRegen; if(s.skillState) skillState=s.skillState; if(s.xpBoost) xpBoost=s.xpBoost;
    currentArea=Number(s.currentArea)||currentArea; traitPoints=Number(s.traitPoints)||traitPoints; if(s.artifacts) artifacts=s.artifacts; if(s.bestiary) bestiary=s.bestiary; if(s.bossLast) bossLast=Number(s.bossLast)||bossLast;
    appendLog("ğŸ’¾ ì €ì¥ ë°ì´í„° ë¶ˆëŸ¬ì˜´");
  }catch(e){console.warn(e);appendLog("âš  ì €ì¥ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨")}
}

/* ë¡œê·¸ helper */
function appendLog(txt){
  const d=document.createElement("div"); d.textContent=txt; logElem.prepend(d);
  while(logElem.children.length>300) logElem.removeChild(logElem.lastChild);
}

/* ì˜¤í”„ë¼ì¸ ë³´ìƒ */
function grantOffline(){
  const last=localStorage.getItem("yugisaRPG2_time"); if(!last) return;
  const ms=Date.now()-Number(last); if(ms<60000) return;
  const minutes=Math.min(Math.floor(ms/60000),60*12); const goldPerMin=Math.max(1,Math.floor((5+currentArea*2)*(1+(upgradeLv*0.02)))); const gained=minutes*goldPerMin; coins+=gained; appendLog(`â³ ì˜¤í”„ë¼ì¸ ë³´ìƒ: ${minutes}ë¶„ ë™ì•ˆ ${gained}ğŸ’°`);
}

/* render map */
function renderMap(){ mapGrid.innerHTML=""; areas.forEach((a,idx)=>{ const n=document.createElement("div"); n.className="map-node"+(playerLv<a.lv?" locked":""); n.innerHTML=`<div style="font-weight:700">${a.name}</div><div style="font-size:12px;color:#bfc7ff">Req LV ${a.lv}</div>`; n.onclick=()=>{ if(playerLv<a.lv){ appendLog(`ğŸš« LV ${a.lv} í•„ìš”`); if(soundEnabled){ failSound.currentTime=0;failSound.play().catch(()=>{});} return;} currentArea=idx; spawnMonster(idx); appendLog(`ğŸ“ ${a.name}ë¡œ ì´ë™`); save(); }; mapGrid.appendChild(n); }); }

/* render shop */
function renderShop(){ shopGrid.innerHTML=""; shopItems.forEach(it=>{ const d=document.createElement("div"); d.className="shop-item"; d.innerHTML=`<div style="font-weight:800">${it.label}</div><div style="font-size:12px;color:#bfc7ff">${it.desc}</div><div style="margin-top:8px;display:flex;justify-content:space-between;align-items:center"><div style="font-size:13px">${it.price}ğŸ’°</div><button class="btn small" onclick="buyItem('${it.id}')">êµ¬ë§¤</button></div>`; shopGrid.appendChild(d); }); }

/* buy */
function buyItem(id){ const it=shopItems.find(x=>x.id===id); if(!it) return; if(coins<it.price){ appendLog("ğŸ’¸ ê³¨ë“œ ë¶€ì¡±"); if(soundEnabled){ failSound.currentTime=0; failSound.play().catch(()=>{});} return;} coins-=it.price; it.onBuy(); if(soundEnabled){ upgradeSound.currentTime=0; upgradeSound.play().catch(()=>{});} updateUI(); save(); }

/* spawn monster */
function spawnMonster(forcedArea){ const a=(typeof forcedArea==='number')?forcedArea:currentArea; monsterMaxHp=30+a*40+kills*2; monsterHp=monsterMaxHp; monsterNameElem.textContent = monsters[a][Math.floor(Math.random()*monsters[a].length)]; areaTextElem.textContent = areas[a].name; updateUI(); }

/* calc trait modifiers + artifacts */
function calcMods(){ const m={atkMult:1,upgradeChanceMod:0,goldMult:1,mpCostMult:1,autoSpeed:1,xpMult:1,mpRegenAdd:0}; const chosen=JSON.parse(localStorage.getItem("yugi_traits")||"[]"); chosen.forEach(id=>{ const td=traitDefs.find(t=>t.id===id); if(td && td.apply) td.apply(m); }); artifacts.forEach(a=>{ if(a && a.apply) a.apply(m); }); return m; }

/* attack */
function attack(){ if(monsterHp<=0) return; monsterHp-=atk; if(soundEnabled){ hitSound.currentTime=0; hitSound.play().catch(()=>{});} if(monsterHp<=0){ if(soundEnabled){ killSound.currentTime=0; killSound.play().catch(()=>{});} kills++; const areaIdx=areaIndex(); const mods=calcMods(); const goldGain=Math.floor((10+areaIdx*6)*(mods.goldMult||1)); coins+=goldGain; const baseXp=8+areaIdx*6; const xpMultFinal=(mods.xpMult||1)*(xpBoost.active && Date.now()<xpBoost.endAt?xpBoost.multiplier:1); const xpGain=Math.floor(baseXp*xpMultFinal); exp+=xpGain; bestiary[areaIdx]=bestiary[areaIdx]||{}; const mname=monsterNameElem.textContent; bestiary[areaIdx][mname]=(bestiary[areaIdx][mname]||0)+1; appendLog(`ğŸª™ +${goldGain} / EXP +${xpGain} â€” ì²˜ì¹˜: ${mname}`); if(mname.includes("ë³´ìŠ¤")){ saveRankingEntry(); } maybeExplorationEvent(); levelUp(); spawnMonster(); } updateUI(); }

/* level up */
function levelUp(){ let leveled=false; while(exp>=nextExp){ exp-=nextExp; playerLv++; atk++; leveled=true; if(soundEnabled){ levelSound.currentTime=0; levelSound.play().catch(()=>{});} appendLog(`ğŸ‰ LVì—…! ${playerLv}`); nextExp=Math.floor(nextExp*1.3); traitPoints++; } if(leveled){ saveRankingEntry(); updateUI(); save(); } }

/* upgrade */
function upgrade(){ const cost=20+upgradeLv*6; if(coins<cost){ appendLog("ğŸ’¸ ê³¨ë“œ ë¶€ì¡±"); if(soundEnabled){ failSound.currentTime=0; failSound.play().catch(()=>{});} return;} coins-=cost; const chance = upgradeLv>=10?95:upgradeChance + (Number(localStorage.getItem("yugi_traits_chance")||0)); if(Math.random()*100<=chance){ upgradeLv++; atk += (upgradeLv>=10?2:1); upgradeChance=Math.max(10,upgradeChance-2); appendLog("âœ¨ ê°•í™” ì„±ê³µ"); if(soundEnabled){ upgradeSound.currentTime=0; upgradeSound.play().catch(()=>{});} } else { appendLog("ğŸ’¥ ê°•í™” ì‹¤íŒ¨"); if(soundEnabled){ failSound.currentTime=0; failSound.play().catch(()=>{});} } updateUI(); save(); }

/* job */
function checkJob(){ if(playerLv>=20 && jobStage===0) jobBtn.style.display="inline-block"; else if(playerLv>=40 && jobStage===1) jobBtn.style.display="inline-block"; else if(playerLv>=60 && jobStage===2) jobBtn.style.display="inline-block"; else jobBtn.style.display="none"; }
function jobChange(){ if(jobStage===0 && playerLv>=20){ job="âš” ìš°ìœ ì°¸ì¹˜"; atk+=5; jobStage=1; } else if(jobStage===1 && playerLv>=40){ job="ğŸ”¥ ì¤€ë¸Œë ˆë“œì—‰ë©ì´"; atk+=10; goldBonus+=0.3; jobStage=2; } else if(jobStage===2 && playerLv>=60){ job="ğŸŒŒ ìœ ê¸°ì‚¬"; atk+=20; goldBonus+=0.7; jobStage=3; } else{ appendLog("ì „ì§ ì¡°ê±´ ë¯¸ì¶©ì¡±"); return; } appendLog(`ğŸŒŸ ì „ì§ ì™„ë£Œ ${job}`); if(soundEnabled){ upgradeSound.currentTime=0; upgradeSound.play().catch(()=>{});} updateUI(); save(); }

/* auto */
function toggleAuto(){ autoHunt=!autoHunt; if(autoHunt){ autoInterval=setInterval(()=>{ if(monsterHp>0) attack(); },400 * (calcMods().autoSpeed||1)); autoBtn.textContent="ğŸ¤– ìë™ì‚¬ëƒ¥ ON"; appendLog("ìë™ì‚¬ëƒ¥ ì‹œì‘"); } else { clearInterval(autoInterval);autoInterval=null; autoBtn.textContent="ğŸ¤– ìë™ì‚¬ëƒ¥ OFF"; appendLog("ìë™ì‚¬ëƒ¥ ì¤‘ì§€"); } }

/* skills */
function useSkill(id){ const s=skillState[id]; const now=Date.now()/1000; if(now - s.last < s.cd){ appendLog(`${s.name} ì¿¨íƒ€ì„`); return; } const mods=calcMods(); const mpCost=Math.ceil(s.mp * (mods.mpCostMult||1)); if(mp<mpCost){ appendLog("MP ë¶€ì¡±"); return; } mp-=mpCost; s.last=now; if(id===1){ const mult=4+Math.floor(s.level/2); const dmg=atk*mult; monsterHp-=dmg; appendLog(`ğŸ’¥ POWER STRIKE Lv${s.level} - ${dmg} dmg`); } else { const hits=2+Math.floor(s.level/2); let total=0; for(let i=0;i<hits;i++){ monsterHp-=atk; total+=atk; } appendLog(`ğŸŒ€ WHIRLWIND Lv${s.level} - ${hits} hits, ${total} dmg`); } if(soundEnabled){ hitSound.currentTime=0; hitSound.play().catch(()=>{});} startCooldownUI(id); if(monsterHp<=0){ if(soundEnabled){ killSound.currentTime=0; killSound.play().catch(()=>{});} kills++; const areaIdx=areaIndex(); coins+=Math.floor((10+areaIdx*6) * goldBonus); exp+=Math.floor((8+areaIdx*6)*(1+upgradeLv*0.1+goldBonus)); levelUp(); spawnMonster(); } updateUI(); }

/* cooldown UI */
function startCooldownUI(id){ const cdElem=document.getElementById(`skill${id}Cd`); const s=skillState[id]; const total=s.cd; cdElem.style.width="100%"; let start=Date.now(); const tick=setInterval(()=>{ const elapsed=(Date.now()-start)/1000; const perc=Math.max(0,(1-elapsed/total))*100; cdElem.style.width=perc+"%"; if(elapsed>=total){ clearInterval(tick); cdElem.style.width="0%"; } },100); }

/* exploration events */
function maybeExplorationEvent(){ if(Math.random() < 0.12){ const r=Math.random(); if(r<0.4){ const goldFound=10+Math.floor(Math.random()*50); coins+=goldFound; appendLog(`ğŸ“¦ ë³´ë¬¼ ìƒì! ${goldFound}ğŸ’°`); } else if(r<0.75){ appendLog("ğŸª¤ ì‘ì€ ì´ë²¤íŠ¸ ë°œìƒ (ì—°ì¶œ)"); } else { spawnMerchant(); } updateUI(); } }

/* merchant */
function spawnMerchant(){ merchantBtn.style.display='inline-block'; merchantBtn.textContent="ë– ëŒì´ ìƒì¸ ë“±ì¥!"; merchantBtn.onclick=()=>{ appendLog("ğŸ§¾ ë– ëŒì´ ìƒì¸ê³¼ ê±°ë˜"); if(coins>=200){ coins-=200; const art=artifactPool[Math.floor(Math.random()*artifactPool.length)]; const idx=artifacts.findIndex(x=>x===null); if(idx>=0){ artifacts[idx]=art; appendLog(`ğŸ”® ${art.name} íšë“(ìŠ¬ë¡¯ ${idx+1})`); } else { appendLog("ìœ ë¬¼ ìŠ¬ë¡¯ì´ ê°€ë“. í™˜ë¶ˆ"); coins+=200; } } else appendLog("ğŸ’¸ ê³¨ë“œ ë¶€ì¡±"); merchantBtn.style.display='none'; updateUI(); save(); }; setTimeout(()=>{ merchantBtn.style.display='none'; },45000); }

/* boss */
function canStartBoss(){ return Date.now()-bossLast >= bossCooldown; }
function showBossButton(){ bossBtnContainer.innerHTML=''; const btn=document.createElement("button"); btn.className='btn small'; btn.textContent='ğŸ”¥ ë³´ìŠ¤ ë ˆì´ë“œ'; btn.onclick=()=>{ if(!canStartBoss()){ appendLog("ë³´ìŠ¤ ì¿¨ë‹¤ìš´ ì¤‘"); return; } startBoss(); }; bossBtnContainer.appendChild(btn); }
function startBoss(){ bossLast=Date.now(); save(); const prev=currentArea; currentArea=5; monsterMaxHp=400+playerLv*20; monsterHp=monsterMaxHp; monsterNameElem.textContent="ë³´ìŠ¤: ìœ ê¸°ì‚¬ (ë ˆì´ë“œ)"; areaTextElem.textContent=areas[5].name; appendLog("âš” ë³´ìŠ¤ ë ˆì´ë“œ ì‹œì‘ (2ë¶„)"); if(soundEnabled){ bossSound.currentTime=0; bossSound.play().catch(()=>{});} updateUI(); setTimeout(()=>{ appendLog("â± ë³´ìŠ¤ ë ˆì´ë“œ ì¢…ë£Œ"); currentArea=prev; spawnMonster(); updateUI(); },120000); }

/* helpers */
function areaIndex(){ return currentArea; }

/* traits UI */
function renderTraits(){ traitsDiv.innerHTML=""; const chosen=JSON.parse(localStorage.getItem("yugi_traits")||"[]"); traitDefs.forEach(td=>{ const d=document.createElement("div"); d.className="trait"; d.innerHTML=`<div style="font-weight:800">${td.name}</div><div style="font-size:12px;color:#bfc7ff">${td.desc}</div><div style="margin-top:6px"><button class="btn small">${chosen.includes(td.id)?'í•´ì œ':'ì„ íƒ'}</button></div>`; const btn=d.querySelector('button'); btn.onclick=()=>{ const now=JSON.parse(localStorage.getItem("yugi_traits")||"[]"); if(now.includes(td.id)){ now.splice(now.indexOf(td.id),1); localStorage.setItem("yugi_traits",JSON.stringify(now)); appendLog(`íŠ¹ì„± í•´ì œ: ${td.name}`); } else { if(traitPoints<=0){ appendLog("íŠ¹ì„± í¬ì¸íŠ¸ ë¶€ì¡±"); return; } now.push(td.id); localStorage.setItem("yugi_traits",JSON.stringify(now)); traitPoints--; appendLog(`íŠ¹ì„± ì„ íƒ: ${td.name}`); } renderTraits(); updateUI(); save(); }; traitsDiv.appendChild(d); }); document.getElementById("traitPoints").textContent=traitPoints; }

/* artifacts UI */
function renderArtifacts(){ artifactsDiv.innerHTML=""; artifacts.forEach((a,idx)=>{ const d=document.createElement("div"); d.className='art-slot'; if(!a){ d.innerHTML=`<div>ìŠ¬ë¡¯ ${idx+1}</div><div style="font-size:12px;color:#bfc7ff">ë¹„ì–´ìˆìŒ</div><div style="margin-top:6px"><button class="btn small" onclick="equipRandom(${idx})">ë¬´ì‘ìœ„ ì¥ì°©</button></div>`; } else { d.innerHTML=`<div style="font-weight:800">${a.name}</div><div style="font-size:12px;color:#bfc7ff">${a.desc}</div><div style="margin-top:6px"><button class="btn small" onclick="unequip(${idx})">í•´ì œ</button></div>`; } artifactsDiv.appendChild(d); }); }
function equipRandom(slot){ const art=artifactPool[Math.floor(Math.random()*artifactPool.length)]; artifacts[slot]=art; appendLog(`ğŸ”® ${art.name} ì¥ì°©`); renderArtifacts(); updateUI(); save(); }
function unequip(slot){ const a=artifacts[slot]; if(!a) return; appendLog(`ğŸ—‘ ${a.name} í•´ì œ`); artifacts[slot]=null; renderArtifacts(); updateUI(); save(); }

/* bestiary */
function renderBestiary(){ bestiaryDiv.innerHTML=""; for(let i=0;i<areas.length;i++){ const obj=bestiary[i]||{}; const keys=Object.keys(obj); const cnt=keys.reduce((s,k)=>s+obj[k],0); const div=document.createElement("div"); div.textContent=`${areas[i].name}: ${cnt}ë§ˆë¦¬`; bestiaryDiv.appendChild(div);} }

/* costumes (simple) */
document.getElementById("costumeDefault")?.addEventListener("click", ()=>{ document.body.style.filter='none'; appendLog("ì˜ìƒ: ê¸°ë³¸"); });
document.getElementById("costumeCool")?.addEventListener("click", ()=>{ document.body.style.filter='contrast(1.05) saturate(1.1)'; appendLog("ì˜ìƒ: ê°„ì§€"); });

/* attendance */
function checkAttendance(){ const today=new Date().toISOString().slice(0,10); const last=localStorage.getItem("lastAttendance"); if(last!==today){ coins+=50; appendLog("ğŸ ì¶œì„ ë³´ìƒ 50ğŸ’°"); localStorage.setItem("lastAttendance",today); updateUI(); save(); } else appendLog("âœ… ì˜¤ëŠ˜ ì´ë¯¸ ì¶œì„"); }

/* update UI */
function updateUI(){ playerLvSpan.textContent=playerLv; playerLvSmall.textContent=playerLv; atkSpan.textContent=atk; coinSpan.textContent=coins; expTextSpan.textContent=`${exp}/${nextExp}`; upgradeLvSpan.textContent=upgradeLv; upgradeCostSpan.textContent=20+upgradeLv*6; jobTextSpan.textContent=job; hpFill.style.width=(monsterMaxHp>0?(monsterHp/monsterMaxHp*100):0)+"%"; mpFill.style.width=(mp/maxMp*100)+"%"; hudMpFill.style.width=(mp/maxMp*100)+"%"; checkJob(); renderMap(); renderShop(); renderTraits(); renderArtifacts(); renderBestiary(); save(); }

/* init events */
function wire(){ attackBtn.onclick=attack; autoBtn.onclick=toggleAuto; upgradeBtn.onclick=upgrade; skill1Btn.onclick=()=>useSkill(1); skill2Btn.onclick=()=>useSkill(2); jobBtn.onclick=jobChange; rankingOpenBtn.onclick=openRanking; window.addEventListener("beforeunload", ()=>{ save(); saveRankingEntry(); }); }
function spawnMonsterInit(){ spawnMonster(); }

/* init */
function init(){ try{ load(); }catch(e){ console.warn(e);} grantOffline(); wire(); renderMap(); renderShop(); renderTraits(); renderArtifacts(); spawnMonster(); updateUI(); appendLog("âœ… ì´ˆê¸°í™” ì™„ë£Œ"); setInterval(()=>{ if(mp<maxMp){ const mods=calcMods(); mp=Math.min(maxMp, mp+mpRegen+(mods.mpRegenAdd||0)); updateUI(); } if(xpBoost.active && Date.now()>=xpBoost.endAt){ xpBoost.active=false; xpBoost.multiplier=1; appendLog("âœ¨ XP ë¶€ìŠ¤í„° ì¢…ë£Œ"); } if(Math.random()<0.005) spawnMerchant(); showBossButton(); },1000); }

/* ===========================
   RANKING: localStorage ê¸°ë°˜ ë¡œì»¬ ë­í‚¹
   =========================== */
function computeScore(){
  // ì¶”ì²œ ì ìˆ˜ì‹
  // ë ˆë²¨(1000) + atk(200) + upgrade(300) + kills(10)
  return (playerLv*1000) + (atk*200) + (upgradeLv*300) + (kills*10);
}
function saveRankingEntry(){
  const name = (playerNameInput.value || "ë¬´ëª…").trim().slice(0,24) || "ë¬´ëª…";
  const entry={name,lv:playerLv,atk,upgrade:upgradeLv,kills,score:computeScore(),time:Date.now()};
  const rankings = JSON.parse(localStorage.getItem("yugisaRanking")||"[]");
  // push then sort desc
  rankings.push(entry);
  rankings.sort((a,b)=>b.score - a.score || a.time - b.time);
  localStorage.setItem("yugisaRanking", JSON.stringify(rankings.slice(0,10)));
  appendLog("ğŸ† ë­í‚¹ ì €ì¥ë¨");
}
function openRanking(){ const rankings = JSON.parse(localStorage.getItem("yugisaRanking")||"[]"); rankingList.innerHTML=""; if(rankings.length===0){ rankingList.textContent="ë­í‚¹ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.";} else { rankings.forEach((r,i)=>{ const row=document.createElement("div"); row.className="rank-row"; row.innerHTML=`<div>#${i+1} ${escapeHtml(r.name)}</div><div>LV ${r.lv} â€¢ âš” ${r.atk} â€¢ S:${r.score}</div>`; rankingList.appendChild(row); }); } rankingModal.style.display="flex"; }
function closeRanking(){ rankingModal.style.display="none"; }
function escapeHtml(s){ return s.replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

/* show ranking button hooked in init via wire() */
function renderShop(){ shopGrid.innerHTML=""; shopItems.forEach(it=>{ const d=document.createElement("div"); d.className="shop-item"; d.innerHTML=`<div style="font-weight:800">${it.label}</div><div style="font-size:12px;color:#bfc7ff">${it.desc}</div><div style="margin-top:8px;display:flex;justify-content:space-between;align-items:center"><div style="font-size:13px">${it.price}ğŸ’°</div><button class="btn small" onclick="buyItem('${it.id}')">êµ¬ë§¤</button></div>`; shopGrid.appendChild(d); }); }

/* debug helpers */
window._resetSave = ()=>{ localStorage.removeItem("yugisaRPG2"); localStorage.removeItem("yugisaRPG2_time"); localStorage.removeItem("yugisaRanking"); location.reload(); };
window._forceSpawn = (i)=>{ spawnMonster(i||currentArea); updateUI(); appendLog("ê°•ì œ ìŠ¤í°"); };

/* start */
init();

</script>
</body>
</html>
