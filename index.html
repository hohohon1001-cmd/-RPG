<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ìœ ê¸°ì‚¬ RPG â€” ì•ˆì •íŒ</title>
<style>
:root{
  --bg1:#071027; --bg2:#020212;
  --accent:#7c8cff; --accent2:#ff9b9b;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:'Segoe UI',system-ui,Arial;background:linear-gradient(180deg,var(--bg1),var(--bg2));color:#e9ecff}
body{display:flex;align-items:center;justify-content:center;padding:20px}
.app{width:100%;max-width:1100px;border-radius:16px;background:linear-gradient(180deg,rgba(2,6,23,0.55),rgba(1,3,10,0.75));padding:16px;display:grid;grid-template-columns:320px 1fr;gap:16px;box-shadow:0 12px 40px rgba(0,0,0,0.6)}
.card{background:rgba(255,255,255,0.02);padding:12px;border-radius:12px}
.hud-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
.hud-item{background:rgba(255,255,255,0.01);padding:10px;border-radius:10px;text-align:center}
.hud-item .label{font-size:12px;color:#bfc7ff}
.hud-item .value{font-weight:800;font-size:18px;color:var(--accent)}
.area{font-weight:800;text-align:center;margin:8px 0}
.monster-card{text-align:center;padding:16px;border-radius:12px;background:linear-gradient(180deg,rgba(10,14,30,0.5),rgba(5,7,12,0.5))}
.monster-name{font-size:20px;font-weight:800;margin-bottom:8px}
.hp-bar{height:14px;background:#111;border-radius:10px;overflow:hidden}
.hp-fill{height:100%;background:linear-gradient(90deg,#ff3b3b,#ff9b9b);width:100%;transition:width .08s}
.btn{display:inline-block;padding:10px 12px;border-radius:12px;border:none;cursor:pointer;background:linear-gradient(90deg,var(--accent),#5b62e8);color:#fff;font-weight:800}
.btn.small{padding:8px 10px;font-size:13px}
.btn.warn{background:linear-gradient(90deg,#ff7b7b,#ffb86b);color:#110f0f}
.btn.auto{background:linear-gradient(90deg,#00ffa6,#00b37a)}
.map-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
.map-node{padding:10px;border-radius:10px;background:rgba(255,255,255,0.02);cursor:pointer;text-align:center}
.map-node.locked{opacity:.45;cursor:not-allowed;filter:grayscale(30%)}
.shop-grid{display:flex;flex-direction:column;gap:8px}
.shop-item{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;background:rgba(255,255,255,0.01)}
.skill-row{display:flex;gap:8px;margin-top:10px}
.skill-btn{flex:1;padding:10px;border-radius:10px;background:linear-gradient(90deg,#ff8b8b,#ffc26f);color:#110;font-weight:800;cursor:pointer;position:relative;overflow:hidden}
.cooldown{position:absolute;left:0;top:0;height:100%;background:rgba(0,0,0,0.45);width:0%;transition:width .2s linear;color:#fff;display:flex;align-items:center;justify-content:center;font-weight:800}
.log{height:140px;overflow:auto;padding:8px;border-radius:8px;background:linear-gradient(90deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02));font-size:13px}
@media(max-width:900px){.app{grid-template-columns:1fr}.map-grid{grid-template-columns:repeat(3,1fr)}}
</style>
</head>
<body>
<div class="app" id="app">
  <!-- LEFT -->
  <div>
    <div class="card">
      <div class="hud-grid">
        <div class="hud-item"><div class="label">LV</div><div id="playerLv" class="value">1</div></div>
        <div class="hud-item"><div class="label">ATK</div><div id="atk" class="value">1</div></div>
        <div class="hud-item"><div class="label">ê°•í™”</div><div id="upgradeLv" class="value">1</div></div>
      </div>
      <div style="margin-top:10px">
        <div class="label" style="color:#bfc7ff">EXP</div>
        <div class="hp-bar" style="height:10px"><div id="expFill" class="hp-fill" style="background:linear-gradient(90deg,#9b8bff,#c4b5ff);width:0%"></div></div>
      </div>
      <div style="margin-top:8px">
        <div class="label" style="color:#bfc7ff">HP</div>
        <div class="hp-bar"><div id="playerHpFill" class="hp-fill" style="width:100%"></div></div>
      </div>
      <div style="margin-top:8px">
        <div class="label" style="color:#bfc7ff">MP</div>
        <div class="hp-bar"><div id="playerMpFill" class="hp-fill" style="background:linear-gradient(90deg,#4be0ff,#2aa8ff);width:100%"></div></div>
      </div>

      <div style="margin-top:10px;display:flex;gap:8px">
        <button id="attackBtn" class="btn">âš” ê³µê²©</button>
        <button id="autoBtn" class="btn auto">ğŸ¤– ìë™ì‚¬ëƒ¥ OFF</button>
      </div>
      <div style="margin-top:8px;display:flex;gap:8px">
        <button id="upgradeBtn" class="btn">ğŸ”§ ê°•í™” (<span id="upgradeCost">20</span>)</button>
        <button id="jobBtn" class="btn warn" style="display:none">ğŸ”® ì „ì§</button>
      </div>
      <div style="margin-top:10px">
        <div class="label" style="color:#bfc7ff">ê³¨ë“œ</div>
        <div id="coin" style="font-weight:800;color:#ffd78e">0</div>
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong>ì¶œì„ì²´í¬</strong>
        <button id="checkBtn" class="btn small">ğŸ“… ì¶œì„</button>
      </div>
      <div id="attendanceMsg" class="small" style="margin-top:8px"></div>
    </div>

    <div class="card" style="margin-top:12px">
      <strong>ìƒì </strong>
      <div id="shopGrid" class="shop-grid" style="margin-top:8px"></div>
    </div>

  </div>

  <!-- RIGHT -->
  <div>
    <div class="card monster-card">
      <div class="monster-name" id="monsterName">ë©œë‹˜</div>
      <div class="hp-bar"><div id="monsterHpFill" class="hp-fill" style="width:100%"></div></div>

      <div style="margin-top:10px;display:flex;gap:8px">
        <button id="spawnBtn" class="btn small">ìŠ¤í° ë¦¬ì…‹</button>
        <button id="bossBtn" class="btn small">ë³´ìŠ¤ ì†Œí™˜</button>
        <button id="saveBtn" class="btn small">ğŸ’¾ ì €ì¥</button>
      </div>

      <div class="skill-row">
        <div id="skill1" class="skill-btn">POWER STRIKE<br><small class="small">MP20 Â· CD6s</small><div id="skill1Cd" class="cooldown"></div></div>
        <div id="skill2" class="skill-btn" style="background:linear-gradient(90deg,#ffd18a,#ff8b8b)">WHIRLWIND<br><small class="small">MP40 Â· CD12s</small><div id="skill2Cd" class="cooldown"></div></div>
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong>ì§€ë„</strong>
        <small class="small">í´ë¦­í•˜ë©´ ì´ë™ (ë ˆë²¨ì¡°ê±´)</small>
      </div>
      <div id="mapGrid" class="map-grid" style="margin-top:8px"></div>
    </div>

    <div class="card" style="margin-top:12px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong>ë¡œê·¸</strong>
        <div id="timeBadge" class="small">ì €ì¥ë¨</div>
      </div>
      <div id="log" class="log" style="margin-top:8px">ì—¬ì •ì´ ì‹œì‘ë˜ì—ˆë‹¤â€¦</div>
    </div>
  </div>
</div>

<!-- audio elements -->
<audio id="hitSound" src="https://assets.mixkit.co/sfx/preview/mixkit-quick-hit-2187.mp3"></audio>
<audio id="killSound" src="https://assets.mixkit.co/sfx/preview/mixkit-video-game-win-2016.mp3"></audio>
<audio id="upgradeSound" src="https://assets.mixkit.co/sfx/preview/mixkit-achievement-bell-600.mp3"></audio>
<audio id="failSound" src="https://assets.mixkit.co/sfx/preview/mixkit-wrong-answer-fail-notification-946.mp3"></audio>
<audio id="levelSound" src="https://assets.mixkit.co/sfx/preview/mixkit-magic-game-win-1949.mp3"></audio>
<audio id="bossSound" src="https://assets.mixkit.co/sfx/preview/mixkit-dramatic-hit-166.mp3"></audio>

<script>
/* Use DOMContentLoaded to ensure all elements exist before binding */
document.addEventListener('DOMContentLoaded', ()=>{

  // ===== DOM cache =====
  const logEl = document.getElementById('log');
  const timeBadge = document.getElementById('timeBadge');
  const monsterNameEl = document.getElementById('monsterName');
  const monsterHpFill = document.getElementById('monsterHpFill');
  const playerLvEl = document.getElementById('playerLv');
  const atkEl = document.getElementById('atk');
  const coinEl = document.getElementById('coin');
  const expFill = document.getElementById('expFill');
  const playerHpFill = document.getElementById('playerHpFill');
  const playerMpFill = document.getElementById('playerMpFill');
  const upgradeLvEl = document.getElementById('upgradeLv');
  const upgradeCostEl = document.getElementById('upgradeCost');
  const jobBtn = document.getElementById('jobBtn');
  const autoBtn = document.getElementById('autoBtn');
  const mapGrid = document.getElementById('mapGrid');
  const shopGrid = document.getElementById('shopGrid');
  const attendanceMsg = document.getElementById('attendanceMsg');
  const skill1Cd = document.getElementById('skill1Cd');
  const skill2Cd = document.getElementById('skill2Cd');

  const hitSound = document.getElementById('hitSound');
  const killSound = document.getElementById('killSound');
  const upgradeSound = document.getElementById('upgradeSound');
  const failSound = document.getElementById('failSound');
  const levelSound = document.getElementById('levelSound');
  const bossSound = document.getElementById('bossSound');

  // ===== Game state =====
  let coins = 0;
  let atk = 1;
  let playerLv = 1;
  let exp = 0;
  let nextExp = 10;
  let upgradeLv = 1;
  let upgradeChance = 90;
  let job = "ë©œë¡œìš°ê¸‰";
  let jobStage = 0;
  let goldBonus = 1;
  let kills = 0;

  let currentMap = 0;
  let monsterHp = 10;
  let monsterMaxHp = 10;

  let mp = 100, maxMp = 100, mpRegen = 1;

  let autoHunt = false, autoInterval = null;

  const skillState = {
    1: { cd:6, last: -9999, mp:20, name:"POWER STRIKE" },
    2: { cd:12, last: -9999, mp:40, name:"WHIRLWIND" }
  };

  const xpBoost = { active:false, endAt:0, multiplier:1 };

  // ===== Map & Monster data (user names kept) =====
  const areas = [
    {name:"ğŸŒ± ì¼ëª»íƒ€", lv:1, bg:"https://images.unsplash.com/photo-1501785888041-af3ef285b470"},
    {name:"ğŸŒ´ ê¸‰ëª»íƒ€", lv:10, bg:"https://images.unsplash.com/photo-1507525428034-b723cf961d3e"},
    {name:"â„ ìœ ê¸°ì‚¬ì˜ ì°¨ê°€ìš´ ë†ë‹´", lv:20, bg:"https://images.unsplash.com/photo-1482192596544-9eb780fc7f66"},
    {name:"ğŸœ ì‹íƒ", lv:30, bg:"https://images.unsplash.com/photo-1504674900247-0877df9cc836"},
    {name:"ğŸŒ‹ íŒ€ ë‚˜ë¹ ", lv:40, bg:"https://images.unsplash.com/photo-1500530855697-b586d89ba3ee"},
    {name:"ğŸŒŒ ìœ ê¸°ì‚¬ ë””ìŠ¤ì½”ë“œ", lv:50, bg:"https://images.unsplash.com/photo-1518770660439-4636190af475"},
    {name:"ğŸ® ë¡œë¸” ì• ë‹ˆ(ìœ ê¸°ì‚¬)", lv:60, bg:"https://images.unsplash.com/photo-1519681393784-d120267933ba"}
  ];

  const monsters = [
    ["ì–´ë ¤ì›Œ í•˜ì‹œëŠ” ë©œë‹˜","ë²¨í‚¤ë‹˜"],
    ["ë˜ ëª»ê¹¨ê³  ìˆëŠ” ë©œë‹˜","ë¨¼ì €ê¹¬ ìš°ì°¸ë‹˜"],
    ["ì™•ì´ ë„˜ì–´ì§€ë©´? í‚¹ì½© ã…‹ã…‹ã…‹","ì•„ë‹ˆ ì‹¤ìˆ˜ë¡œ ë¼ì´ë²Œ ë“¤ì–´ê°"],
    ["ì˜·ì— ë–¨ì–´ì§„ ë°¥í’€","í›„ì‹ìœ¼ë¡  ì¤€ë¸Œë ˆë“œ ì—‰ë©ì´"],
    ["ì§­ ìœ ê¸°ì‚¬","ë©œë‹˜ìœ¼ë¡œ ìœ„ì¥í•œ ì¤€ë¸Œë ˆë“œ"],
    ["ìì¹¼ë‹˜","í‘í™”í•œ ë©œë‹˜","ë³´ìŠ¤: ìœ ê¸°ì‚¬ok"],
    ["ìœ ê¸°ì‚¬","ë² ì´ì»¨","ë³´ìŠ¤: ë² ì´ì»¨ ì—„ë§ˆ"]
  ];

  // ===== Shop items =====
  const shopItems = [
    { id:"atk_boost", label:"ê³µê²©ì˜ ë³´ì„", desc:"ATK +1 (ì˜êµ¬)", price:150, onBuy:()=>{
      atk += 1; log("ğŸ—¡ ê³µê²©ë ¥ +1 íšë“");
    }},
    { id:"mana_pot", label:"ë§ˆë‚˜ ë¬¼ì•½", desc:"MP +50 ì¦‰ì‹œ íšŒë³µ", price:40, onBuy:()=>{
      mp = Math.min(maxMp, mp+50); log("ğŸ· ë§ˆë‚˜ +50");
    }},
    { id:"cool_reduce", label:"ìŠ¤í‚¬ ì—°ë§ˆì„œ", desc:"ëª¨ë“  ìŠ¤í‚¬ ì¿¨ë‹¤ìš´ -1ì´ˆ", price:120, onBuy:()=>{
      Object.values(skillState).forEach(s=> s.cd = Math.max(1, s.cd-1));
      log("ğŸ“š ìŠ¤í‚¬ ì¿¨ë‹¤ìš´ ê°ì†Œ");
    }},
    { id:"xp_boost", label:"XP ë¶€ìŠ¤í„°(30s)", desc:"ê²½í—˜ì¹˜ 2ë°° 30ì´ˆ", price:100, onBuy:()=>{
      xpBoost.active=true; xpBoost.multiplier=2; xpBoost.endAt=Date.now()+30000;
      log("âœ¨ XP 2ë°° ì ìš© (30s)");
    }}
  ];

  // ===== Utility: log =====
  function log(text){
    const d = document.createElement('div');
    d.textContent = text;
    logEl.prepend(d);
  }

  function save(silent = false){
  try{
    const data = {
      coins,
      atk,
      playerLv,
      exp,
      nextExp,
      upgradeLv,
      upgradeChance,
      job,
      jobStage,
      goldBonus,
      kills,
      mp,
      maxMp,
      skillState,
      currentMap
    };

function save(){
  try{
    const data = {
      coins,
      atk,
      playerLv,
      exp,
      nextExp,
      upgradeLv,
      upgradeChance,
      job,
      jobStage,
      goldBonus,
      kills,
      mp,
      maxMp,
      skillState,
      currentMap
    };

    localStorage.setItem("yugisa_save_v3", JSON.stringify(data));
    localStorage.setItem("yugisa_save_time", Date.now());

    // âŒ ë¡œê·¸ ì¶œë ¥ ì—†ìŒ (ì™„ì „íˆ ì¡°ìš©)
  }catch(e){
    console.error("Save error:", e);
  }
}

  function load(){
    try{
      const raw = localStorage.getItem('yugisa_save_v3');
      if(!raw) return;
      const s = JSON.parse(raw);
      coins = Number(s.coins)||coins;
      atk = Number(s.atk)||atk;
      playerLv = Number(s.playerLv)||playerLv;
      exp = Number(s.exp)||exp;
      nextExp = Number(s.nextExp)||nextExp;
      upgradeLv = Number(s.upgradeLv)||upgradeLv;
      upgradeChance = Number(s.upgradeChance)||upgradeChance;
      job = s.job||job;
      jobStage = Number(s.jobStage)||jobStage;
      goldBonus = Number(s.goldBonus)||goldBonus;
      kills = Number(s.kills)||kills;
      mp = Number(s.mp)||mp;
      maxMp = Number(s.maxMp)||maxMp;
      if(s.skillState) {
        Object.keys(s.skillState).forEach(k=> skillState[k] = s.skillState[k]);
      }
      currentMap = Number(s.currentMap)||currentMap;
      log("ğŸ’½ ì €ì¥ ë°ì´í„° ë¶ˆëŸ¬ì˜´");
    }catch(e){
      console.warn("ë¡œë“œ ì‹¤íŒ¨", e);
      log("âš  ë¡œë“œ ì‹¤íŒ¨");
    }
  }

  // ===== Map render & spawn =====
  function renderMap(){
    mapGrid.innerHTML = '';
    areas.forEach((a, idx)=>{
      const node = document.createElement('div');
      node.className = 'map-node' + ((playerLv < a.lv) ? ' locked' : '') + ((currentMap===idx) ? ' active' : '');
      node.innerHTML = `<div style="font-weight:800">${a.name}</div><div class="small">Req LV ${a.lv}</div>`;
      node.addEventListener('click', ()=>{
        if(playerLv < a.lv){ log(`ğŸš« LV ${a.lv} ì´ìƒ í•„ìš”`); return; }
        currentMap = idx;
        spawnMonster();
        log(`ğŸ“ ${a.name} ì§€ì—­ìœ¼ë¡œ ì´ë™`);
      });
      mapGrid.appendChild(node);
    });
  }

  function spawnMonster(){
    const a = currentMap;
    monsterMaxHp = 30 + a*40 + kills*2 + Math.floor(playerLv*2);
    monsterHp = monsterMaxHp;
    const name = monsters[a][Math.floor(Math.random()*monsters[a].length)];
    monsterNameEl.textContent = name;
    document.body.style.backgroundImage = `url(${areas[currentMap].bg})`;
    if(name.includes('ë³´ìŠ¤') && bossSound) bossSound.play().catch(()=>{});
    updateUI();
  }

  // ===== Combat =====
  function attack(){
    monsterHp -= atk;
    if(hitSound) { hitSound.currentTime=0; hitSound.play().catch(()=>{}); }
    if(monsterHp <= 0){
      if(killSound) { killSound.currentTime=0; killSound.play().catch(()=>{}); }
      kills++;
      let drop = Math.random();
      if(drop < 0.05){ coins += 100; log("ğŸŒˆ ë¬´ì§€ê°œ ê³¨ë“œ íšë“!!!"); }
      else coins += Math.floor((10 + currentMap*6) * goldBonus);
      const baseXp = 8 + currentMap*6;
      const mult = xpBoost.active && Date.now() < xpBoost.endAt ? xpBoost.multiplier : 1;
      exp += Math.floor(baseXp * (1 + upgradeLv*0.08 + goldBonus) * mult);
      levelUp();
      spawnMonster();
    }
    updateUI();
  }

  function spawnBoss(){
    const boss = monsters[currentMap][monsters[currentMap].length-1] || 'ë³´ìŠ¤';
    monsterNameEl.textContent = boss;
    monsterMaxHp = Math.floor(monsterMaxHp * 2.5);
    monsterHp = monsterMaxHp;
    if(bossSound) bossSound.play().catch(()=>{});
    log("ğŸ‘¹ ë³´ìŠ¤ ì†Œí™˜!");
    updateUI();
  }

  // ===== Level up =====
  function levelUp(){
    while(exp >= nextExp){
      exp -= nextExp;
      playerLv++;
      atk++;
      playerLvEl.textContent = playerLv;
      if(levelSound) levelSound.currentTime=0, levelSound.play().catch(()=>{});
      log(`ğŸ‰ ë ˆë²¨ì—…! LV ${playerLv}`);
      nextExp = Math.floor(nextExp * 1.3);
    }
    checkJob();
  }

  // ===== Upgrade =====
  function upgrade(){
    const cost = 20 + upgradeLv*6;
    if(coins < cost){ log("ğŸ’¸ ê³¨ë“œ ë¶€ì¡±!"); if(failSound) failSound.play().catch(()=>{}); return; }
    coins -= cost;
    const chance = upgradeLv >= 10 ? 95 : upgradeChance;
    if(Math.random()*100 <= chance){
      upgradeLv++;
      atk += (upgradeLv>=10?2:1);
      upgradeChance = Math.max(10, upgradeChance-2);
      if(upgradeSound) upgradeSound.currentTime=0, upgradeSound.play().catch(()=>{});
      log("âœ¨ ê°•í™” ì„±ê³µ!");
    } else {
      if(failSound) failSound.currentTime=0, failSound.play().catch(()=>{});
      log("ğŸ’¥ ê°•í™” ì‹¤íŒ¨â€¦");
    }
    updateUI();
  }

  // ===== Job / check =====
  function checkJob(){
    if(playerLv>=20 && jobStage===0) jobBtn.style.display="inline-block";
    else if(playerLv>=40 && jobStage===1) jobBtn.style.display="inline-block";
    else if(playerLv>=60 && jobStage===2) jobBtn.style.display="inline-block";
    else jobBtn.style.display="none";
  }
  function jobChange(){
    if(jobStage===0 && playerLv>=20){ job="âš” ìš°ìœ ì°¸ì¹˜"; atk+=5; jobStage=1; }
    else if(jobStage===1 && playerLv>=40){ job="ğŸ”¥ ì¤€ë¸Œë ˆë“œì—‰ë©ì´"; atk+=10; goldBonus+=0.3; jobStage=2; }
    else if(jobStage===2 && playerLv>=60){ job="ğŸŒŒ ìœ ê¸°ì‚¬"; atk+=20; goldBonus+=0.7; jobStage=3; }
    else { log("ì „ì§ ì¡°ê±´ ë¯¸ì¶©ì¡±"); return; }
    log(`ğŸŒŸ ì „ì§ ì™„ë£Œ! ${job}`);
    if(upgradeSound) upgradeSound.currentTime=0, upgradeSound.play().catch(()=>{});
    updateUI();
  }

  // ===== Auto hunt =====
  function toggleAuto(){
    autoHunt = !autoHunt;
    if(autoHunt){
      autoBtn.textContent = "ğŸ¤– ìë™ì‚¬ëƒ¥ ON";
      if(autoInterval) clearInterval(autoInterval);
      autoInterval = setInterval(()=>{ if(monsterHp>0) attack(); }, 220);
      log("ìë™ì‚¬ëƒ¥ ì‹œì‘");
    } else {
      autoBtn.textContent = "ğŸ¤– ìë™ì‚¬ëƒ¥ OFF";
      if(autoInterval) clearInterval(autoInterval);
      autoInterval = null;
      log("ìë™ì‚¬ëƒ¥ ì¤‘ì§€");
    }
  }

  // ===== Skills =====
  function useSkill(id){
    const s = skillState[id];
    const now = Date.now()/1000;
    if(now - s.last < s.cd){ log(`${s.name}ì€(ëŠ”) ì•„ì§ ì¿¨íƒ€ì„ì…ë‹ˆë‹¤.`); return; }
    if(mp < s.mp){ log("MPê°€ ë¶€ì¡±í•©ë‹ˆë‹¤."); return; }
    mp -= s.mp;
    s.last = now;

    if(id===1){
      const dmg = atk * 5;
      monsterHp -= dmg;
      log(`ğŸ’¥ ${s.name}! ${dmg} ëŒ€ë¯¸ì§€`);
    } else if(id===2){
      const dmg = atk * 3;
      monsterHp -= dmg;
      log(`ğŸŒ€ ${s.name}! ${dmg} ëŒ€ë¯¸ì§€`);
    }

    if(hitSound) hitSound.currentTime=0, hitSound.play().catch(()=>{});
    startCooldownUI(id);

    if(monsterHp<=0){
      if(killSound) killSound.currentTime=0, killSound.play().catch(()=>{});
      kills++;
      coins += Math.floor((10 + currentMap*6) * goldBonus);
      exp += Math.floor((8 + currentMap*6) * (1 + upgradeLv*0.1 + goldBonus));
      levelUp();
      spawnMonster();
    }
    updateUI();
  }

  function startCooldownUI(id){
    const cdElem = id===1 ? skill1Cd : skill2Cd;
    const s = skillState[id];
    cdElem.style.width = "100%";
    let start = Date.now();
    const tick = setInterval(()=>{
      const elapsed = (Date.now() - start)/1000;
      const perc = Math.max(0, (1 - elapsed/s.cd))*100;
      cdElem.style.width = perc + "%";
      if(elapsed >= s.cd) { clearInterval(tick); cdElem.style.width = "0%"; }
    }, 100);
  }

  // ===== MP regen & xp booster check =====
  setInterval(()=>{
    if(mp < maxMp){ mp = Math.min(maxMp, mp + mpRegen); updateUI(); }
    if(xpBoost.active && Date.now() >= xpBoost.endAt){ xpBoost.active=false; xpBoost.multiplier=1; log("XP ë¶€ìŠ¤í„° ì¢…ë£Œ"); }
  }, 1000);

  // ===== Attendance =====
  function checkAttendance(){
    const today = new Date().toISOString().slice(0,10);
    const last = localStorage.getItem('yugisa_attendance');
    if(last !== today){
      coins += 5000;
      localStorage.setItem('yugisa_attendance', today);
      attendanceMsg.textContent = "ğŸ ì˜¤ëŠ˜ ì¶œì„ ë³´ìƒ 5000 ì§€ê¸‰!";
      log("ğŸ ì¶œì„ ë³´ìƒ ì§€ê¸‰");
      updateUI();
    } else {
      attendanceMsg.textContent = "âœ… ì˜¤ëŠ˜ ì´ë¯¸ ì¶œì„í•¨";
    }
  }

  // ===== Shop buy =====
  function buyItem(id){
    const it = shopItems.find(s=>s.id===id);
    if(!it) return;
    if(coins < it.price){ log("ê³¨ë“œ ë¶€ì¡±"); if(failSound) failSound.play().catch(()=>{}); return; }
    coins -= it.price;
    it.onBuy();
    if(upgradeSound) upgradeSound.currentTime=0, upgradeSound.play().catch(()=>{});
    updateUI();
  }

  // ===== UI update =====
  function updateUI(){
    playerLvEl.textContent = playerLv;
    atkEl.textContent = atk;
    coinEl.textContent = coins;
    upgradeLvEl.textContent = upgradeLv;
    upgradeCostEl.textContent = 20 + upgradeLv*6;
    expFill.style.width = Math.min(100, Math.floor((exp/nextExp)*100)) + '%';
    monsterHpFill.style.width = Math.max(0, Math.floor((monsterHp/monsterMaxHp)*100)) + '%';
    playerHpFill.style.width = '100%'; // placeholder: we don't track player HP loss here
    playerMpFill.style.width = Math.min(100, Math.floor((mp/maxMp)*100)) + '%';
    renderMap();
    renderShop();
    save(); // autosave
  }

  // ===== Render shop =====
  function renderShop(){
    shopGrid.innerHTML = '';
    shopItems.forEach(it=>{
      const div = document.createElement('div');
      div.className = 'shop-item';
      div.innerHTML = `<div><strong>${it.label}</strong><div class="small">${it.desc}</div></div>
                       <div style="text-align:right"><div class="small">${it.price}ğŸ’°</div><button class="btn small">êµ¬ë§¤</button></div>`;
      div.querySelector('button').addEventListener('click', ()=> buyItem(it.id));
      shopGrid.appendChild(div);
    });
  }

  // ===== Event bindings =====
  document.getElementById('attackBtn').addEventListener('click', ()=> attack());
  document.getElementById('spawnBtn').addEventListener('click', ()=> { spawnMonster(); log('ìŠ¤í° ë¦¬ì…‹'); });
  document.getElementById('bossBtn').addEventListener('click', ()=> spawnBoss());
  document.getElementById('saveBtn').addEventListener('click', ()=> save());
  document.getElementById('upgradeBtn').addEventListener('click', ()=> upgrade());
  document.getElementById('autoBtn').addEventListener('click', ()=> toggleAuto());
  document.getElementById('jobBtn').addEventListener('click', ()=> jobChange());
  document.getElementById('checkBtn').addEventListener('click', ()=> checkAttendance());
  document.getElementById('skill1').addEventListener('click', ()=> useSkill(1));
  document.getElementById('skill2').addEventListener('click', ()=> useSkill(2));

  // ===== Initial load + render =====
  load();
  renderShop();
  renderMap();
  spawnMonster();
  updateUI();
  log("ê²Œì„ ì´ˆê¸°í™” ì™„ë£Œ â€” í´ë¦­ìœ¼ë¡œ ì‚¬ìš´ë“œ í™œì„±í™” í›„ í”Œë ˆì´í•˜ì„¸ìš”.");

  // ===== Debug help in console =====
  window._Y = {
    state: ()=> ({coins,atk,playerLv,exp,nextExp,upgradeLv,currentMap,monsterHp,monsterMaxHp,mp}),
    spawnMonster, attack, toggleAuto, upgrade, useSkill, save
  };

}); // DOMContentLoaded end
</script>
</body>
</html>
